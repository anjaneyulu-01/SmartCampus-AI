<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PresenceAI — Unified Demo</title>
  <link rel="stylesheet" href="main.css">
  <style>
    /* ---------- Dark theme + visual tweaks (overrides) ---------- */
    :root{
      --muted:#9ca3af;
      --bg:#071014; /* deep black-blue */
      --panel:#07131a;
      --card:#071a20;
      --fg:#e6eef6;
      --accent:#10b981; /* green */
      --accent-2:#06b6d4;
      --danger:#ef4444;
      --late:#f59e0b;
      --suspicious:#8b5cf6;
      --glass: rgba(255,255,255,0.03);
    }

    /* base */
    html,body { height:100%; }
    body { font-family: Inter, Arial, sans-serif; margin:0; background: linear-gradient(180deg, #000814 0%, var(--bg) 100%); color:var(--fg); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

    /* sidebar */
    .sidebar { width:260px; position:fixed; left:0; top:0; bottom:0; background: linear-gradient(180deg, rgba(2,6,23,0.95), rgba(4,8,15,0.92)); color:var(--fg); padding:20px; display:flex; flex-direction:column; gap:12px; border-right:1px solid rgba(255,255,255,0.03); }
    .logo { font-weight:800; font-size:20px; color:var(--accent); background:linear-gradient(90deg,var(--accent),var(--accent-2)); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; }
    .title { font-size:18px; color:var(--fg); margin-bottom:6px; }

    .class-selector { width:100%; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.05); background:transparent; color:var(--fg); }

    .nav { display:flex; flex-direction:column; gap:6px; margin-top:6px; }
    .nav-link { background:transparent; border:0; color:var(--muted); padding:10px; text-align:left; cursor:pointer; border-radius:8px; font-weight:600; }
    .nav-link.active { background: linear-gradient(90deg, rgba(16,185,129,0.08), rgba(6,182,212,0.04)); color:var(--fg); box-shadow: 0 6px 20px rgba(6,182,212,0.04); }

    .badge { background:transparent; padding:6px 8px; border-radius:6px; color:var(--fg); font-weight:700; border:1px solid rgba(255,255,255,0.04); display:inline-block; }

    .btn-ghost { background:transparent; color:var(--fg); border:1px solid rgba(255,255,255,0.06); padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:700; }
    .btn-primary { background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#02141a; border:0; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:800; box-shadow: 0 8px 28px rgba(16,185,129,0.12); }

    .main { margin-left:280px; padding:22px; min-height:100vh; }

    .stat-card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)); padding:14px; border-radius:12px; box-shadow: 0 8px 30px rgba(2,6,23,0.6); flex:1; display:flex; justify-content:space-between; align-items:center; color:var(--fg); border:1px solid rgba(255,255,255,0.03); }

    .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:14px; border-radius:12px; box-shadow:0 18px 50px rgba(2,6,23,0.6); color:var(--fg); border:1px solid rgba(255,255,255,0.03); }

    /* presence grid & cards */
    .presence-grid { display:flex; flex-wrap:wrap; gap:12px; margin-top:12px; }
    .presence-card { width:160px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); padding:12px; border-radius:12px; text-align:center; position:relative; transition: transform 180ms ease, box-shadow 220ms ease; border:1px solid rgba(255,255,255,0.03); }
    .presence-card:hover { transform: translateY(-6px); box-shadow: 0 18px 40px rgba(2,12,20,0.7); }

    .presence-card img { width:72px; height:72px; border-radius:50%; object-fit:cover; border:2px solid rgba(255,255,255,0.04); display:block; margin:0 auto; }

    .presence-card .name { margin-top:8px; font-weight:800; color:var(--fg); }
    .presence-card .text-sm { color:var(--muted); margin-top:4px; }

    /* dynamic status border + glow */
    .presence-card.status-present { border:1px solid rgba(16,185,129,0.24); box-shadow: 0 0 18px rgba(16,185,129,0.12), inset 0 -6px 18px rgba(16,185,129,0.02); }
    .presence-card.status-absent  { border:1px solid rgba(239,68,68,0.14); box-shadow: 0 0 12px rgba(239,68,68,0.06); opacity:0.95; }
    .presence-card.status-late    { border:1px solid rgba(245,158,11,0.16); box-shadow:0 0 16px rgba(245,158,11,0.06); }
    .presence-card.status-suspicious { border:1px solid rgba(139,92,246,0.12); box-shadow:0 0 18px rgba(139,92,246,0.06); }

    /* status pill */
    .status { padding:6px 10px; border-radius:14px; display:inline-block; font-weight:800; text-transform:capitalize; margin-top:8px; color:#04111b; }
    .status.present { background: linear-gradient(90deg,var(--accent), #2dd4bf); color:#021414; }
    .status.absent  { background: linear-gradient(90deg,var(--danger), #fb7185); color:#fff; }
    .status.late    { background: linear-gradient(90deg,var(--late), #fb923c); color:#071017; }
    .status.suspicious { background: linear-gradient(90deg,var(--suspicious), #c084fc); color:#071017; }

    /* glow pulse for present */
    @keyframes glowPulse {
      0% { box-shadow: 0 0 0 rgba(16,185,129,0.12); }
      50% { box-shadow: 0 0 18px rgba(16,185,129,0.18); transform: translateY(-4px); }
      100% { box-shadow: 0 0 0 rgba(16,185,129,0.12); transform: translateY(0); }
    }
    .presence-card.status-present .status { animation: glowPulse 2.6s ease-in-out infinite; }

    /* inline/horizontal buttons */
    .presence-card .controls-inline { display:flex; gap:8px; justify-content:center; margin-top:10px; flex-wrap:wrap; }
    .presence-card .controls-inline .btn-ghost { padding:6px 8px; font-size:0.9rem; border-radius:8px; }

    /* --------------------- NEW: Google Meet style attendance cards --------------------- */

    /* attendance grid container (Meet-like) */
    #attendanceList {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); /* responsive wrapping */
      gap: 12px;
      align-items: start;
      margin-top: 12px;
    }

    /* meet-style tile */
    .presence-card.meet {
      width: 100%;
      height: 120px;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.03);
      transition: transform 160ms ease, box-shadow 200ms ease;
      overflow: hidden;
    }
    .presence-card.meet:hover { transform: translateY(-6px); box-shadow: 0 20px 50px rgba(0,0,0,0.6); }

    .presence-card.meet .meet-avatar {
      flex: 0 0 92px;
      width: 92px;
      height: 68px;
      border-radius: 8px;
      overflow: hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      background: linear-gradient(180deg, rgba(0,0,0,0.06), rgba(0,0,0,0.02));
      border: 1px solid rgba(255,255,255,0.03);
    }
    .presence-card.meet .meet-avatar img {
      width: 88px;
      height: 64px;
      object-fit:cover;
      border-radius:6px;
      display:block;
    }

    .presence-card.meet .meet-body {
      flex: 1 1 auto;
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }

    .presence-card.meet .meet-head {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }

    .presence-card.meet .meet-name {
      font-weight:800;
      font-size:1rem;
      color:var(--fg);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .presence-card.meet .meet-meta {
      color:var(--muted);
      font-size:0.9rem;
      display:flex;
      gap:8px;
      align-items:center;
    }

    .presence-card.meet .meet-actions {
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:8px;
      flex-wrap:wrap;
    }

    /* put status pill on right side for quick glance */
    .presence-card.meet .status {
      padding:6px 10px;
      border-radius:10px;
      font-weight:800;
      font-size:0.85rem;
    }

    /* attendance mark button style (smaller) */
    .btn-mark { padding:6px 10px; border-radius:8px; font-weight:700; background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--fg); cursor:pointer; }
    .btn-mark.primary { background: linear-gradient(90deg,var(--accent),var(--accent-2)); color:#021414; border:0; }

    /* small utilities */
    .muted { color:var(--muted); }
    .small { font-size:0.9rem; }
    .top-grid { display:flex; gap:8px; flex-wrap:wrap; }
    .top-card { width:120px; background:var(--card); padding:8px; border-radius:8px; text-align:center; }

    /* ensure canvas contrast */
    canvas { background: transparent; border-radius:8px; display:block; }

    /* responsive adjustments */
    @media (max-width:900px){
      .sidebar { display:none; }
      .main { margin-left:0; padding:12px; }
      #attendanceList { grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
      .presence-card.meet { height:110px; }
      .presence-card img { width:56px; height:56px; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar">
    <div class="logo">PA</div>
    <h2 class="title">PresenceAI</h2>
    <select id="classSelector" class="class-selector" aria-label="Filter by class">
      <option value="all">All Classes</option>
      <option value="A">Class A</option>
      <option value="B">Class B</option>
      <option value="C">Class C</option>
    </select>
    <nav class="nav" role="navigation">
      <button data-page="page-dashboard" class="nav-link active" aria-pressed="true">Dashboard</button>
      <button data-page="page-presence" class="nav-link" aria-pressed="false">Presence Map</button>
      <button data-page="page-attendance" class="nav-link" aria-pressed="false">Attendance</button>
      <button data-page="page-trust" class="nav-link" aria-pressed="false">Trust Score</button>
      <button data-page="page-insights" class="nav-link">Insights</button>
    </nav>
    <div class="legend" aria-hidden="true" style="opacity:0.85">
      <p><span class="dot present"></span> Present</p>
      <p><span class="dot absent"></span> Absent</p>
      <p><span class="dot late"></span> Late</p>
      <p><span class="dot suspicious"></span> Suspicious</p>
    </div>
    <div style="margin-top:auto">
      <div style="font-weight:700">Signed in as</div>
      <div id="signedUser" style="margin-top:6px; font-weight:800">Guest</div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="openSign" class="btn-ghost">Sign In</button>
        <button id="signOut" class="btn-ghost" style="display:none">Sign Out</button>
      </div>
    </div>
  </aside>

  <!-- Main content -->
  <main id="mainContent" class="main">
    <!-- Dashboard Page -->
    <section id="page-dashboard" class="page active" aria-live="polite">
      <header class="page-header">
        <h1>Dashboard</h1>
        <div style="display:flex;align-items:center;gap:12px">
          <div class="badge" id="roleBadge">Guest</div>
          <div class="controls">
            <button id="regenUsers" class="btn-ghost" title="Regenerate sample data">Regenerate</button>
            <button id="downloadSnapshot" class="btn-ghost" title="Download CSV snapshot">Export CSV</button>
          </div>
        </div>
      </header>
      <div class="stats">
        <div class="stat-card">Present <span id="stat-present" class="number">0</span></div>
        <div class="stat-card">Absent <span id="stat-absent" class="number">0</span></div>
        <div class="stat-card">Late <span id="stat-late" class="number">0</span></div>
      </div>
      <div class="grid-2" style="display:flex;gap:12px;margin-top:12px;">
        <div class="card" style="flex:1;">
          <h3>Quick Presence Preview</h3>
          <div id="presencePreview" class="presence-grid" style="margin-top:12px;"></div>
          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <button id="openPresence" class="btn-primary">Open Full Map</button>
            <button id="addStudentBtn" class="btn-ghost" style="display:none">Add Student</button>
          </div>
        </div>
        <div class="card" style="flex:1">
          <h3>Leader board</h3>
          <div id="leaderboard" class="leaderboard"></div>
        </div>
      </div>
    </section>

    <!-- Presence Map Page -->
    <section id="page-presence" class="page" aria-hidden="true">
      <header class="page-header"><h1>Presence Map</h1></header>
      <div id="presenceMap" class="presence-grid"></div>
    </section>

    <!-- Attendance Page (new) -->
    <section id="page-attendance" class="page" aria-hidden="true">
      <header class="page-header" style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <h1>Attendance</h1>
          <div id="attendanceSub" style="color:var(--muted); font-weight:700; margin-top:6px;">Choose class & date to load attendance</div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <select id="attendanceClass" class="class-selector" aria-label="Filter by class for attendance">
            <option value="all">All Classes</option>
            <option value="A">Class A</option>
            <option value="B">Class B</option>
            <option value="C">Class C</option>
          </select>
          <input id="attendanceDate" type="date" class="class-selector" style="padding:8px; background:#071a20; color:var(--fg);" />
          <button id="loadAttendanceBtn" class="btn-ghost">Load</button>
          <button id="attendanceUnpinBtn" class="btn-ghost" style="display:none;margin-left:6px">Unpin</button>
          <button id="attendanceExportBtn" class="btn-ghost">Export CSV</button>
        </div>
      </header>

      <div class="card">
        <h3>Attendance for <span id="attendanceTitle">--</span></h3>
        <div id="attendanceList" style="margin-top:12px;"></div>
      </div>
    </section>

    <!-- Trust Score Page -->
    <section id="page-trust" class="page" aria-hidden="true">
      <header class="page-header"><h1>Trust Score</h1></header>
      <div class="trust-layout">
        <div class="trust-top">
          <h3>Top Students</h3>
          <div id="trustTopGrid" class="top-grid"></div>
        </div>

        <div class="trust-list">
          <h3>All Students</h3>
          <div id="trustLeaderboard" class="leaderboard scrollable"></div>
        </div>
      </div>
    </section>

    <!-- Insights Page -->
    <section id="page-insights" class="page" aria-hidden="true">
      <header class="page-header"><h1>Insights</h1></header>

      <div class="insights-container">
        <!-- Left: AI Analytics list (scrollable) -->
        <div class="analytics-list" id="analyticsList">
          <div class="searchbox">
            <input id="analyticsSearch" placeholder="Search analytics..." aria-label="Search analytics"/>
            <div class="analytics-badge live-badge" title="Live">LIVE</div>
          </div>
          <!-- analytics items appended here -->
        </div>

        <!-- Right: detail view (chart + pie + details) -->
        <div class="insights-right" id="insightsRight">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <h3 id="insightTitle" style="margin:0">Select an analysis</h3>
              <div id="insightDesc" style="color:var(--muted); font-size:0.95rem; margin-top:6px;">Click an item on the left to view graphs & breakdowns.</div>
            </div>
            <div style="text-align:right; color:var(--muted); font-weight:600;">
              <div style="font-size:0.85rem; margin-bottom:6px;">Class filter:</div>
              <div id="insightFilterText">All</div>
            </div>
          </div>

          <div class="topbar" style="justify-content:space-between;">
            <div class="controls" style="gap:10px;">
              <button id="refreshInsight" class="btn-ghost">Refresh</button>
              <button id="exportInsightCSV" class="btn-ghost">Export CSV</button>
            </div>
            <div style="color:var(--muted); font-weight:700;">Snapshot • <span id="insightTime">--</span></div>
          </div>

          <!-- Charts row: line + pie (pie has legend to right) -->
          <div class="charts-row" style="margin-top:12px;">
            <div class="chart-card chart-large">
              <canvas id="lineChart" role="img" aria-label="Trend line chart"></canvas>
            </div>
            <div style="display:flex;flex-direction:column;gap:10px;">
              <div class="chart-card chart-small">
                <canvas id="pieChart" role="img" aria-label="Distribution pie chart"></canvas>
              </div>
              <div id="pieLegend" style="margin-top:6px; font-size:0.9rem;"></div>
            </div>
          </div>

          <!-- Trust card + tips below charts -->
          <div style="margin-top:12px;">
            <div class="trust-card">
              <div class="trust-big">
                <div style="font-size:0.95rem;font-weight:800;color:var(--fg)">Trust Score</div>
                <div id="trustNumber" class="trust-number">--</div>
                <div id="trustPctDesc" class="trust-sub">Average trust across filtered users</div>
                <div style="margin-top:6px;"><button id="improveScore" class="btn-primary">Improve My Score</button></div>
              </div>
              <div>
                <h4 style="margin:0 0 8px 0;">AI Tips</h4>
                <div class="tips-list" id="tipsList">
                  <!-- tips appended here -->
                </div>
              </div>
            </div>
          </div>

          <div class="analytics-details" style="margin-top:14px;">
            <div class="details-card">
              <h4>Top students (by trust)</h4>
              <div id="topStudentsList" class="small-list"></div>
            </div>
            <div class="details-card">
              <h4>Quick stats</h4>
              <div id="quickStats" style="font-size:0.95rem; color:var(--muted);"></div>
            </div>
          </div>

        </div>
      </div>
    </section>
  </main>

  <!-- Add student modal -->
  <div id="addModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:#071a20; padding:18px; border-radius:10px; z-index:10000;">
    <h3 style="color:var(--fg)">Add Student</h3>
    <label for="addId" style="color:var(--muted)">Student ID</label>
    <input id="addId" placeholder="unique id (e.g. sai)" />
    <label for="addName" style="color:var(--muted)">Name</label>
    <input id="addName" placeholder="Full name" />
    <label for="addClass" style="color:var(--muted)">Class</label>
    <input id="addClass" placeholder="A / B / C" />
    <label for="addMobile" style="color:var(--muted)">Mobile</label>
    <input id="addMobile" placeholder="Mobile (for parent login)" />
    <label for="addAvatar" style="color:var(--muted)">Avatar (optional)</label>
    <input id="addAvatar" type="file" accept="image/*" />
    <label for="addFace" style="color:var(--muted)">Face image (optional)</label>
    <input id="addFace" type="file" accept="image/*" />
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="saveAdd" class="btn-primary">Save</button>
      <button id="cancelAdd" class="btn-ghost">Cancel</button>
    </div>
    <div id="addMsg" class="small muted" style="margin-top:8px"></div>
  </div>

  <!-- Sign-in modal -->
  <div id="signModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" style="display:none; position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); background:#071a20; padding:18px; border-radius:10px; z-index:10000;">
    <h3 style="color:var(--fg)">Sign In</h3>
    <label for="signRole" style="color:var(--muted)">Role</label>
    <select id="signRole">
      <option value="hod">HOD</option>
      <option value="teacher">Teacher</option>
      <option value="parent">Parent</option>
    </select>
    <label for="signUser" style="color:var(--muted)">Username</label>
    <input id="signUser" placeholder="hod / teacher or child's name for parent" />
    <label for="signPass" style="color:var(--muted)">Password</label>
    <input id="signPass" placeholder="password" />
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="doSign" class="btn-primary">Sign In</button>
      <button id="cancelSign" class="btn-ghost">Cancel</button>
    </div>
    <div id="signMsg" class="small muted" style="margin-top:8px"></div>
  </div>

  <script>
  // --- API Base auto-detect ---
  let API_BASE;
  if (location.port === "5500" || location.protocol === "file:") {
    API_BASE = "http://127.0.0.1:8000";
  } else {
    API_BASE = location.origin;
  }
  console.log("Using API_BASE =", API_BASE);

  /* ---------- Client-side JS for dashboard + role logic ---------- */

  // Utility state
  let users = [];
  let selectedClass = "all";
  let selectedAnalyticsId = null;
  let attendancePinned = false;
  let pinnedAttendanceDate = null;
  let pinnedAttendanceClass = 'all';
  let pinnedAttendanceRecords = {};

  // --- NEW: helper to get ISO date (yyyy-mm-dd) for 'today' and compare dates ---
  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function isoFromTimestamp(ts){
    try {
      if(!ts) return null;
      const d = new Date(ts);
      if(isNaN(d)) return null;
      return d.toISOString().slice(0,10);
    } catch(e){ return null; }
  }
  function sameISODate(a, b){
    if(!a || !b) return false;
    return String(a).slice(0,10) === String(b).slice(0,10);
  }

  function normalizeNameKey(name){
    if(!name) return '';
    return String(name).toLowerCase().replace(/\s+/g,' ').trim();
  }

  function getPinnedStatusForUser(u){
    if(!attendancePinned || !pinnedAttendanceRecords) return null;
    const candidates = [];
    if(u == null) return null;
    if(u.id !== undefined && u.id !== null) candidates.push(String(u.id));
    if(u.student_id !== undefined && u.student_id !== null) candidates.push(String(u.student_id));
    if(u.studentId !== undefined && u.studentId !== null) candidates.push(String(u.studentId));
    const n = normalizeNameKey(u.name || u.display_name || u.fullName || '');
    if(n) candidates.push(n);
    for(const c of [...candidates]){
      if(typeof c === 'string' && c.startsWith('U')) candidates.push(c.replace(/^U/,'') );
      else if(typeof c === 'string' && /^\d+$/.test(c)) candidates.push('U' + c);
    }
    for(const k of candidates){
      if(!k) continue;
      if(pinnedAttendanceRecords.hasOwnProperty(k)) return pinnedAttendanceRecords[k];
    }
    return null;
  }

  const ANALYTICS = [
    { id:'late_month', title:'Late — This Month', description:'Percentage of students marked late (snapshot)', compute: null },
    { id:'punctuality_A', title:'Punctuality — Class A', description:'Punctuality issues for class A', compute: null },
    { id:'consistent_C', title:'Consistent — Class C', description:'Students with high consistency (trust ≥ 85) in Class C', compute: null },
    { id:'suspicious_count', title:'Suspicious activity', description:'Number of flagged suspicious statuses', compute: null },
    { id:'avg_trust', title:'Average Trust', description:'Average trust across the filtered population', compute: null },
    { id:'attendance_rate', title:'Attendance Rate', description:'Estimated present vs absent snapshot', compute: null }
  ];

  function getToken() { return localStorage.getItem('pa_token'); }
  async function apiFetch(path, opts = {}) {
    opts = opts || {};
    opts.headers = opts.headers || {};
    if (!opts.headers['Accept']) opts.headers['Accept'] = 'application/json, text/plain, */*';
    const t = getToken();
    if (t) opts.headers['Authorization'] = 'Bearer ' + t;
    const url = path.startsWith('http') ? path : `${API_BASE.replace(/\/$/,'')}${path.startsWith('/') ? '' : '/'}${path}`;
    let res;
    try {
      res = await fetch(url, opts);
    } catch (networkErr) {
      console.error('Network error fetching', url, networkErr);
      throw { message: 'Network error', detail: networkErr };
    }
    const ct = res.headers.get('content-type') || '';
    let body;
    try {
      if (ct.includes('application/json')) {
        body = await res.json().catch(()=>null);
      } else {
        body = await res.text().catch(()=>null);
      }
    } catch (parseErr) {
      body = await res.text().catch(()=>null);
    }
    if (!res.ok) {
      console.warn('apiFetch non-OK', { url, status: res.status, body });
      throw body || { message: 'Request failed', status: res.status };
    }
    return body;
  }

  function normalizeAvatarUrl(u) {
    const defaultPath = '/avatars/default.jpg';
    if (!u) {
      return API_BASE.replace(/\/$/, '') + defaultPath;
    }
    if (typeof u === 'object') {
      u = u.avatar || u.avatarUrl || u.avatar_url || u.photo || u.photoUrl || u.photo_url || u.name || '';
    }
    u = String(u || '').trim();
    if (!u) return API_BASE.replace(/\/$/, '') + defaultPath;
    if (u.startsWith('http://') || u.startsWith('https://') || u.startsWith('data:')) return u;
    if (u.startsWith('/')) return API_BASE.replace(/\/$/, '') + u;
    return API_BASE.replace(/\/$/, '') + '/avatars/' + u;
  }

  async function loadUsers(){
    try {
      const data = await apiFetch('/api/students');
      users = Array.isArray(data) ? data : [];
    } catch (e) {
      console.warn('loadUsers failed', e);
      users = [];
    }
    // normalize fields and ensure present-mark date tracking kept client-side
    users.forEach(u => {
      u.status = (u.status || '').toLowerCase();
      // if backend provides lastSeen or liveSeenAt, keep it; otherwise keep existing
      if(!u.liveSeenAt && u.last_seen) u.liveSeenAt = u.last_seen;
      // keep a client-side field presentMarkedDate if present already today
      if(!u.presentMarkedDate && (String(u.status || '').toLowerCase() === 'present')) {
        // prefer explicit timestamp if provided
        const iso = isoFromTimestamp(u.liveSeenAt) || todayISO();
        u.presentMarkedDate = iso;
      }
    });
    toggleRoleControls();
    if(attendancePinned){
      try { renderAttendanceList(); } catch(e){ console.warn('renderAttendanceList during pinned refresh failed', e); }
    } else {
      renderCurrentPage();
    }
  }

  let _loadUsersRunning = false;
  async function safeLoadUsersOnce(){
    if(_loadUsersRunning) return;
    _loadUsersRunning = true;
    try {
      await loadUsers();
    } catch(e){
      console.warn('safeLoadUsersOnce loadUsers failed', e);
    } finally {
      setTimeout(()=> { _loadUsersRunning = false; }, 600);
    }
  }

  // --- IMPORTANT: when updating presence we now protect "present" for the same day ---
  function updateUserPresence(payload){
    if(!payload || !payload.student_id) return;
    const sid = payload.student_id;
    const incomingStatus = (payload.status || 'present').toString().toLowerCase();
    const idx = users.findIndex(u => String(u.id) === String(sid) || String(u.student_id) === String(sid));
    if(idx === -1){
      // unknown student; trigger reload
      safeLoadUsersOnce();
      return;
    }

    // If current user is already present for the same ISO date, preserve present
    const existing = users[idx];
    const existingStatus = (existing.status || '').toLowerCase();
    const existingPresentDate = existing.presentMarkedDate || isoFromTimestamp(existing.liveSeenAt);

    // incoming timestamp ISO-date for comparison
    const incomingIso = isoFromTimestamp(payload.timestamp) || todayISO();

    // Rule: if existingStatus === 'present' and presentMarkedDate === today => keep present no matter incoming 'late'
    if(existingStatus === 'present' && existingPresentDate && sameISODate(existingPresentDate, incomingIso) && incomingStatus === 'late'){
      // just refresh liveSeenAt but do not change status
      existing.liveSeenAt = payload.timestamp || new Date().toISOString();
      // re-render counts & card
      try {
        const filtered = filterUsers();
        document.getElementById('stat-present').innerText = filtered.filter(u=> (u.status||'').toLowerCase() === 'present').length;
        document.getElementById('stat-absent').innerText = filtered.filter(u=> (u.status||'').toLowerCase() === 'absent').length;
        document.getElementById('stat-late').innerText = filtered.filter(u=> (u.status||'').toLowerCase() === 'late').length;
      } catch(e){ console.warn('update counts failed', e); }
      // update card info (time only)
      try {
        const card = document.querySelector(`.presence-card[data-id="${sid}"]`);
        if(card){
          const timeEl = card.querySelector('.live-seen-at');
          if(timeEl){
            timeEl.innerText = new Date(existing.liveSeenAt || Date.now()).toLocaleTimeString();
          }
        } else {
          const activePage = document.querySelector('.page.active');
          if(activePage && activePage.id === 'page-presence') {
            renderPresence('presenceMap');
          } else {
            renderDashboard();
          }
        }
      } catch(e){ console.warn('update card (preserve present) failed', e); }
      return;
    }

    // Otherwise apply incoming status normally
    const status = incomingStatus;
    users[idx].status = status;
    users[idx].liveSeenAt = payload.timestamp || new Date().toISOString();

    // If incoming status is present, record presentMarkedDate (client-side)
    if(status === 'present'){
      users[idx].presentMarkedDate = isoFromTimestamp(users[idx].liveSeenAt) || todayISO();
    }

    try {
      const filtered = filterUsers();
      document.getElementById('stat-present').innerText = filtered.filter(u=> (u.status||'').toLowerCase() === 'present').length;
      document.getElementById('stat-absent').innerText = filtered.filter(u=> (u.status||'').toLowerCase() === 'absent').length;
      document.getElementById('stat-late').innerText = filtered.filter(u=> (u.status||'').toLowerCase() === 'late').length;
    } catch(e){
      console.warn('update counts failed', e);
    }

    try {
      const card = document.querySelector(`.presence-card[data-id="${sid}"]`);
      if(card){
        const statusEl = card.querySelector('.status');
        if(statusEl){
          statusEl.className = 'status ' + status;
          statusEl.innerText = (payload.status || status).toString();
        }
        // add class to card for border/glow
        card.classList.remove('status-present','status-absent','status-late','status-suspicious');
        card.classList.add('status-' + status);
        const timeEl = card.querySelector('.live-seen-at');
        if(timeEl){
          timeEl.innerText = new Date(payload.timestamp || Date.now()).toLocaleTimeString();
        }
      } else {
        const activePage = document.querySelector('.page.active');
        if(activePage && activePage.id === 'page-presence') {
          renderPresence('presenceMap');
        } else {
          renderDashboard();
        }
      }
    } catch(e){
      console.warn('update card failed', e);
      renderCurrentPage();
    }
  }

  // when applying attendance records we apply same "present-preserve" rule
  function applyAttendanceToUsers(attRecords){
    if(!Array.isArray(attRecords)) return;
    const idToIndex = {};
    users.forEach((u,i)=> idToIndex[String(u.id)] = i);
    let updatedCount = 0;
    for(const r of attRecords){
      const sid = String(r.student_id || r.id || r.studentId || '').trim();
      if(!sid) continue;
      const idx = idToIndex[sid];
      if(idx === undefined || idx === -1){
        console.warn('Attendance record for unknown student', sid, r);
        continue;
      }
      const statusIncoming = (r.status || r.state || r.label || '').toString().toLowerCase() || 'present';
      // preserve present for same day if already present
      const existing = users[idx];
      const existingPresentDate = existing.presentMarkedDate || isoFromTimestamp(existing.liveSeenAt);
      const recordIso = isoFromTimestamp(r.timestamp || r.date || r.ts) || todayISO();

      if(existing.status === 'present' && existingPresentDate && sameISODate(existingPresentDate, recordIso) && statusIncoming === 'late') {
        // keep present but update timestamp
        existing.liveSeenAt = r.timestamp || existing.liveSeenAt || new Date().toISOString();
      } else {
        // apply record
        users[idx].status = statusIncoming;
        users[idx].liveSeenAt = r.timestamp || new Date().toISOString();
        if(statusIncoming === 'present') users[idx].presentMarkedDate = isoFromTimestamp(users[idx].liveSeenAt) || todayISO();
      }
      updatedCount++;
    }
    console.log(`Applied attendance to ${updatedCount} users`);
    renderDashboard();
    const active = document.querySelector('.page.active');
    if(active && active.id === 'page-presence') renderPresence('presenceMap');
  }

  function filterUsers(){
    return users.filter(u => selectedClass === 'all' || (u.class || '').toString() === selectedClass);
  }

  // build presence-card html — updated to include status-specific card class + inline controls
  function userCard(u){
    const statusLower = (u.status || '').toLowerCase();
    const avatarField = u.photo || u.photo_url || u.photoUrl || u.avatar || u.avatarUrl || u.avatar_url || u.avatarUrl || '';
    const avatarSrc = normalizeAvatarUrl(avatarField || u.avatarUrl || u.avatar_url);
    const onerr = `this.onerror=null;this.src='${API_BASE.replace(/\/$/,'')}/avatars/default.jpg'`;
    // ensure the card has a data-live timestamp to show
    const liveTime = u.liveSeenAt ? (new Date(u.liveSeenAt).toLocaleTimeString()) : '';
    // card class includes status-* for borders/glow
    const cardClass = `presence-card status-${statusLower}`;

    return `
      <div class="${cardClass}" data-id="${u.id}">
        <img src="${avatarSrc}" alt="${u.name}" onerror="${onerr}">
        <div style="margin-top:8px">
          <div class="name">${u.name}</div>
          <div class="text-sm muted">${u.class || ''} ${u.student_id ? ' • ' + u.student_id : ''}</div>
        </div>
        <div style="margin-top:8px">
          <div class="status ${statusLower}">${u.status || 'absent'}</div>
        </div>
        <div style="margin-top:8px" class="small muted live-seen-at">${liveTime}</div>
        <div class="controls-inline" style="margin-top:10px">
          ${canMark() ? `<button class="btn-ghost mark-btn" data-id="${u.id}">Mark</button>` : ''}
          ${isHod() ? `<button class="btn-ghost del-btn" data-id="${u.id}">Delete</button>` : ''}
        </div>
      </div>`;
  }

  function renderPresence(containerId){
    const container = document.getElementById(containerId);
    container.innerHTML = filterUsers().map(userCard).join('');
    wirePresenceButtons();
  }

  function renderDashboard(){
    const data = filterUsers();
    document.getElementById('stat-present').innerText = data.filter(u=> (u.status||'').toLowerCase() === 'present').length;
    document.getElementById('stat-absent').innerText = data.filter(u=> (u.status||'').toLowerCase() === 'absent').length;
    document.getElementById('stat-late').innerText = data.filter(u=> (u.status||'').toLowerCase() === 'late').length;
    document.getElementById('presencePreview').innerHTML = data.slice(0,6).map(userCard).join('');
  }

  async function renderTimeline(){
    const t = document.getElementById('timeline');
    if(!t) return;
    t.innerHTML = '';
    const data = filterUsers().slice(0,12);
    for (const u of data){
      try {
        const hist = await apiFetch(`/api/timeline/${encodeURIComponent(u.id)}`);
        const html = (Array.isArray(hist) ? hist : []).map(h=>`<div style="padding:6px;border-bottom:1px dashed #eef2f7"><strong>${h.ts}</strong> ${h.type} - ${h.label || ''}</div>`).join('');
        const entry = document.createElement('div');
        entry.className = 'timeline-entry';
        entry.innerHTML = `<strong>${u.name}</strong> (${u.class}) - ${u.status}<hr>${html}`;
        t.appendChild(entry);
      } catch (e) {
        const entry = document.createElement('div');
        entry.className = 'timeline-entry';
        entry.innerHTML = `<strong>${u.name}</strong> (${u.class}) - ${u.status}<hr>No timeline`;
        t.appendChild(entry);
      }
    }
  }

  async function renderTrustPage(){
    const data = filterUsers();
    const top = [...data].sort((a,b)=> (b.trustScore||0) - (a.trustScore||0)).slice(0,6);
    document.getElementById('trustTopGrid').innerHTML = top.map(u=>{
      const avatarField = u.photo || u.photo_url || u.photoUrl || u.avatar || u.avatarUrl || u.avatar_url || '';
      const avatarSrc = normalizeAvatarUrl(avatarField);
      const onerr = `this.onerror=null;this.src='${API_BASE.replace(/\/$/,'')}/avatars/default.jpg'`;
      return `
        <div class="top-card">
          <img src="${avatarSrc}" alt="${u.name}" onerror="${onerr}" style="width:56px;height:56px;border-radius:8px;object-fit:cover;">
          <div class="name">${u.name}</div>
          <div class="class muted">${u.class}</div>
          <div class="score">${u.trustScore}%</div>
        </div>
      `}).join('');
    document.getElementById('trustLeaderboard').innerHTML = [...data].sort((a,b)=> (b.trustScore||0) - (a.trustScore||0)).map((u,i)=>`<div><span>${i+1}. ${u.name} (${u.class})</span><span>${u.trustScore}%</span></div>`).join('');
  }

  function renderInsights(){
    document.getElementById('analyticsList').innerHTML = `
      <div class="searchbox">
        <input id="analyticsSearch" placeholder="Search analytics..." aria-label="Search analytics"/>
        <div class="analytics-badge live-badge" title="Live">LIVE</div>
      </div>
    `;
    for (const a of ANALYTICS){
      const el = document.createElement('div');
      el.className = 'analytics-item';
      el.dataset.id = a.id;
      el.innerHTML = `<div class="meta"><div class="analytics-title">${a.title}</div><div class="analytics-desc">${a.description}</div></div><div class="analytics-badge">View</div>`;
      document.getElementById('analyticsList').appendChild(el);
    }
    document.querySelectorAll('.analytics-item').forEach(item=>{
      item.onclick = () => {
        document.querySelectorAll('.analytics-item').forEach(i=>i.classList.remove('selected'));
        item.classList.add('selected');
        selectedAnalyticsId = item.dataset.id;
        showAnalyticsDetail(selectedAnalyticsId);
      };
    });
    const first = document.querySelector('.analytics-item');
    if(first){
      first.classList.add('selected');
      selectedAnalyticsId = first.dataset.id;
      showAnalyticsDetail(selectedAnalyticsId);
    }
    const search = document.getElementById('analyticsSearch');
    if(search) search.oninput = (e)=> renderInsightsFiltered(e.target.value);
  }

  function renderInsightsFiltered(filterText){
    document.getElementById('analyticsList').innerHTML = `
      <div class="searchbox">
        <input id="analyticsSearch" placeholder="Search analytics..." aria-label="Search analytics" value="${filterText}"/>
        <div class="analytics-badge live-badge" title="Live">LIVE</div>
      </div>
    `;
    for (const a of ANALYTICS){
           if(filterText && !(`${a.title} ${a.description}`.toLowerCase().includes(filterText.toLowerCase()))) continue;
      const el = document.createElement('div');
      el.className = 'analytics-item';
      el.dataset.id = a.id;
      el.innerHTML = `<div class="meta"><div class="analytics-title">${a.title}</div><div class="analytics-desc">${a.description}</div></div><div class="analytics-badge">View</div>`;
      document.getElementById('analyticsList').appendChild(el);
    }
    document.querySelectorAll('.analytics-item').forEach(item=>{
      item.onclick = () => {
        document.querySelectorAll('.analytics-item').forEach(i=>i.classList.remove('selected'));
        item.classList.add('selected');
        selectedAnalyticsId = item.dataset.id;
        showAnalyticsDetail(selectedAnalyticsId);
      };
    });
  }

  function makeLastDays(n){
    const labels = [];
    for (let i=n-1;i>=0;i--){
      if(i===0) labels.push('Today'); else labels.push(`D-${i}`);
    }
    return labels;
  }
  function makeTrend(base, points=7){
    const arr=[];
    for(let i=0;i<points;i++){
      const jitter = Math.round((Math.random()*12)-6);
      let v = Math.max(0, Math.min(100, base + jitter));
      arr.push(v);
    }
    return arr;
  }
  function topByTrust(list, n=5){
    return [...list].sort((a,b)=> (b.trustScore||0) - (a.trustScore||0)).slice(0,n);
  }

  function showAnalyticsDetail(id){
    const analytic = ANALYTICS.find(a=>a.id===id);
    if(!analytic) return;
    const filtered = filterUsers();
    let data;
    if(id === 'late_month'){
      const total = filtered.length || 1;
      const late = filtered.filter(u=> (u.status||'').toLowerCase() === 'late').length;
      const perc = Math.round((late/total)*100);
      data = { pie: [late, total-late], pieLabels: ['Late','On time'], trend: makeTrend(perc,7), trendLabels: makeLastDays(7), detailsTitle: `${perc}% students late`, topStudents: topByTrust(filtered,5) };
    } else if(id === 'punctuality_A'){
      const onlyA = filtered.filter(u=> u.class === 'A');
      const total = onlyA.length || 1;
      const notPunctual = onlyA.filter(u=> (u.trustScore||0) < 75 ).length;
      const perc = Math.round((notPunctual/total)*100);
      data = { pie: [notPunctual, total-notPunctual], pieLabels: ['Not punctual','Punctual'], trend: makeTrend(perc,7), trendLabels: makeLastDays(7), detailsTitle: total===0 ? 'No students in Class A' : `${perc}% not punctual in Class A`, topStudents: topByTrust(onlyA,5) };
    } else if(id === 'consistent_C'){
      const onlyC = filtered.filter(u=> u.class === 'C');
      const total = onlyC.length || 1;
      const consistent = onlyC.filter(u=> (u.trustScore||0) >= 85).length;
      const perc = Math.round((consistent/total)*100);
      data = { pie: [consistent, total-consistent], pieLabels: ['Consistent','Not consistent'], trend: makeTrend(perc,7), trendLabels: makeLastDays(7), detailsTitle: total===0 ? 'No students in Class C' : `${perc}% consistent in Class C`, topStudents: topByTrust(onlyC,5) };
    } else if(id === 'suspicious_count'){
      const total = filtered.length || 1;
      const suspicious = filtered.filter(u=> (u.status||'').toLowerCase() === 'suspicious').length;
      const perc = Math.round((suspicious/total)*100);
      data = { pie: [suspicious, total-suspicious], pieLabels: ['Suspicious','Normal'], trend: makeTrend(perc,7), trendLabels: makeLastDays(7), detailsTitle: `${suspicious} flagged suspicious`, topStudents: topByTrust(filtered,5) };
    } else if(id === 'avg_trust'){
      const total = filtered.length || 1;
      const avg = Math.round(filtered.reduce((a,b)=> a + (b.trustScore||0), 0) / total);
      data = { pie: [avg, 100-avg], pieLabels: ['Avg trust','Remaining to 100'], trend: makeTrend(avg,7), trendLabels: makeLastDays(7), detailsTitle: `Average trust ${avg}%`, topStudents: topByTrust(filtered,5) };
    } else if(id === 'attendance_rate'){
      const total = filtered.length || 1;
      const present = filtered.filter(u=> (u.status||'').toLowerCase() === 'present').length;
      const perc = Math.round((present/total)*100);
      data = { pie: [present, total-present], pieLabels: ['Present','Absent'], trend: makeTrend(perc,7), trendLabels: makeLastDays(7), detailsTitle: `${perc}% present`, topStudents: topByTrust(filtered,5) };
    }

    document.getElementById('insightTitle').innerText = analytic.title;
    document.getElementById('insightDesc').innerText = analytic.description;
    document.getElementById('insightFilterText').innerText = (selectedClass==='all' ? 'All' : selectedClass);
    document.getElementById('insightTime').innerText = new Date().toLocaleString();

    drawLineChart(document.getElementById('lineChart'), data.trendLabels, data.trend);
    drawPieChart(document.getElementById('pieChart'), data.pie, data.pieLabels);

    document.getElementById('pieLegend').innerHTML = data.pieLabels.map((lab,i)=>{
      const colors = ["#ef4444","#16a34a","#f59e0b","#8b5cf6","#0ea5e9","#e11d48"];
      return `<div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
        <div style="width:12px;height:12px;border-radius:3px;background:${colors[i%colors.length]};"></div>
        <div style="flex:1">${lab}</div>
        <div style="font-weight:700">${data.pie[i]}</div>
      </div>`;
    }).join("");

    const topDiv = document.getElementById('topStudentsList');
    topDiv.innerHTML = data.topStudents && data.topStudents.length ? data.topStudents.map((s,idx)=>`<div><span>${idx+1}. ${s.name}</span><span>${s.trustScore||s.trust}%</span></div>`).join('') : `<div style="color:var(--muted)">No students to show</div>`;

    document.getElementById('quickStats').innerHTML = `<div style="color:var(--muted)">${data.detailsTitle || ''}</div>`;

    const avgTrust = Math.round(filtered.reduce((a,b)=> a + (b.trustScore||0), 0) / (filtered.length || 1));
    document.getElementById('trustNumber').innerText = avgTrust + '%';
    document.getElementById('trustPctDesc').innerText = `Average trust across ${filtered.length} users`;

    const tips = [];
    if(avgTrust < 70) tips.push('Focus on verification — run spot checks for identities.');
    else tips.push('Trust level is good — maintain verification cadence.');
    const suspicious = filtered.filter(u=> (u.status||'').toLowerCase() === 'suspicious').length;
    if(suspicious > 0) tips.push(`Investigate ${suspicious} suspicious flag(s) — review footage or logs.`);
    else tips.push('No suspicious flags — continue monitoring.');
    tips.push('Enable two-factor checks & regular audit to raise trust.');

    document.getElementById('tipsList').innerHTML = tips.map(t=>`<div class="tip">${t}</div>`).join('');
  }

  function setCanvasForRetina(canvas){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    const width = rect.width || canvas.offsetWidth || 300;
    const height = rect.height || canvas.offsetHeight || 200;
    canvas.width = Math.round(width * dpr);
    canvas.height = Math.round(height * dpr);
    canvas.style.width = width + "px";
    canvas.style.height = height + "px";
    const ctx = canvas.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return {ctx, w:width, h:height};
  }
  function clearCanvas(canvas){
    const {ctx, w, h} = setCanvasForRetina(canvas);
    ctx.clearRect(0,0,w,h);
    return {ctx, w, h};
  }

  function drawLineChart(canvas, labels, values){
    const {ctx, w, h} = clearCanvas(canvas);
    if(!values || values.length === 0){
      ctx.fillStyle = "#64748b";
      ctx.font = "14px Inter, Arial";
      ctx.fillText("No data", w/2 - 18, h/2);
      return;
    }
    const padding = {left:42, right:18, top:28, bottom:44};
    const chartW = w - padding.left - padding.right;
    const chartH = h - padding.top - padding.bottom;
    ctx.strokeStyle = "#eef4fb";
    ctx.lineWidth = 1;
    ctx.beginPath();
    for(let i=0;i<5;i++){
      const y = padding.top + (chartH/4)*i;
      ctx.moveTo(padding.left, y);
      ctx.lineTo(w - padding.right, y);
    }
    ctx.stroke();

    const max = Math.max(...values, 10);
    const min = 0;
    const vRange = max - min || 1;

    ctx.lineWidth = 2.8;
    const grad = ctx.createLinearGradient(0, 0, w, 0);
    grad.addColorStop(0, "rgba(16,185,129,0.95)");
    grad.addColorStop(1, "rgba(6,182,212,0.98)");
    ctx.strokeStyle = grad;
    ctx.beginPath();
    values.forEach((val, idx)=>{
      const x = padding.left + (chartW/(values.length-1 || 1)) * idx;
      const y = padding.top + chartH - ((val - min) / vRange) * chartH;
      if(idx===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();

    ctx.lineTo(padding.left + chartW, padding.top + chartH);
    ctx.lineTo(padding.left, padding.top + chartH);
    ctx.closePath();
    const fillGrad = ctx.createLinearGradient(0, padding.top, 0, padding.top + chartH);
    fillGrad.addColorStop(0, "rgba(6,182,212,0.12)");
    fillGrad.addColorStop(1, "rgba(16,185,129,0.02)");
    ctx.fillStyle = fillGrad;
    ctx.fill();

    ctx.fillStyle = "#fff";
    ctx.strokeStyle = "#0ea5e9";
    ctx.lineWidth = 1.6;
    ctx.font = "12px Inter, Arial";
    ctx.fillStyle = "#e6eef6";
    values.forEach((val, idx)=>{
      const x = padding.left + (chartW/(values.length-1 || 1)) * idx;
      const y = padding.top + chartH - ((val - min) / vRange) * chartH;
      ctx.beginPath();
      ctx.arc(x,y,4,0,Math.PI*2);
      ctx.fillStyle = "#fff";
      ctx.fill();
      ctx.strokeStyle = "#0ea5e9";
      ctx.stroke();
      ctx.fillStyle = "#e6eef6";
      ctx.fillText(val + "%", x - 14, y - 12);
    });

    ctx.fillStyle = "#94a3b8";
    ctx.font = "12px Inter, Arial";
    labels.forEach((lab, idx)=>{
      const x = padding.left + (chartW/(labels.length-1 || 1)) * idx;
      ctx.fillText(lab, x - 14, padding.top + chartH + 22);
    });

    ctx.fillStyle = "#e6eef6";
    ctx.font = "600 13px Inter, Arial";
    ctx.fillText("Trend", 8, 18);
  }

  function drawPieChart(canvas, values, labels){
    const {ctx, w, h} = clearCanvas(canvas);
    const cx = w/2;
    const cy = h/2;
    const radius = Math.min(w, h)/2 - 16;
    const total = values.reduce((a,b)=>a+b,0) || 1;
    const colors = ["#ef4444","#16a34a","#f59e0b","#8b5cf6","#0ea5e9","#e11d48"];
    let start = -Math.PI/2;
    for(let i=0;i<values.length;i++){
      const slice = values[i] / total;
      const end = start + slice * Math.PI * 2;
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,radius,start,end);
      ctx.closePath();
      ctx.fillStyle = colors[i % colors.length];
      ctx.fill();
      ctx.strokeStyle = "#071014";
      ctx.lineWidth = 1;
      ctx.stroke();
      start = end;
    }
    ctx.fillStyle = "#e6eef6";
    ctx.font = "700 14px Inter, Arial";
    ctx.textAlign = "center";
    ctx.fillText("Distribution", cx, cy - 6);
    ctx.font = "600 12px Inter, Arial";
    ctx.fillText(`${values[0] || 0}`, cx, cy + 18);
  }

  function showPage(id){
    document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
    const pageEl = document.getElementById(id);
    if(pageEl) pageEl.classList.add("active");
    document.querySelectorAll(".nav-link").forEach(btn=>{ btn.classList.remove('active'); btn.setAttribute('aria-pressed','false'); });
    const btn = document.querySelector(`.nav-link[data-page="${id}"]`);
    if(btn){ btn.classList.add('active'); btn.setAttribute('aria-pressed','true'); }
    if(id === "page-dashboard") renderDashboard();
    if(id === "page-presence") renderPresence("presenceMap");
    if(id === "page-attendance") {
      const dateInput = document.getElementById('attendanceDate');
      if(attendancePinned){
        if(dateInput && pinnedAttendanceDate) dateInput.value = pinnedAttendanceDate;
      } else {
        if(dateInput && !dateInput.value) {
          const today = new Date();
          const year = today.getFullYear();
          const month = String(today.getMonth() + 1).padStart(2, '0');
          const day = String(today.getDate()).padStart(2, '0');
          dateInput.value = `${year}-${month}-${day}`;
        }
      }
      renderAttendanceList();
    }
    if(id === "page-trust") renderTrustPage();
    if(id === "page-insights") { renderInsights(); if(selectedAnalyticsId) showAnalyticsDetail(selectedAnalyticsId); }
    setTimeout(()=>{ if(id==='page-insights' && selectedAnalyticsId) showAnalyticsDetail(selectedAnalyticsId); }, 60);
  }

  document.querySelectorAll(".nav-link").forEach(btn=> btn.addEventListener('click', ()=> {
    const target = btn.dataset.page;
    if(target !== 'page-attendance') {
      attendancePinned = false;
      pinnedAttendanceDate = null;
      pinnedAttendanceClass = 'all';
      try { const unpinBtn = document.getElementById('attendanceUnpinBtn'); if(unpinBtn){ unpinBtn.style.display = 'none'; } } catch(e){}
      try { localStorage.removeItem('pa_attendance_pinned'); localStorage.removeItem('pa_attendance_date'); localStorage.removeItem('pa_attendance_class'); } catch(e){}
    }
    showPage(target);
  }) );

  document.getElementById("openPresence").addEventListener('click', ()=> showPage("page-presence"));

  document.getElementById("classSelector").addEventListener('change', (e)=> {
    selectedClass = e.target.value;
    const active = document.querySelector('.page.active');
    if(active) showPage(active.id);
    else renderDashboard();
  });

  document.getElementById('downloadSnapshot').addEventListener('click', ()=> {
    const rows = users.map(u=>({ id:u.id, name:u.name, class:u.class, status:u.status, trust:u.trustScore }));
    exportCSV(rows, `presence_snapshot_${Date.now()}.csv`);
  });

  document.getElementById('exportInsightCSV').addEventListener('click', ()=> {
    const filtered = filterUsers();
    const rows = filtered.map(u=>({ id:u.id, name:u.name, class:u.class, status:u.status, trust:u.trustScore }));
    exportCSV(rows, `insight_export_${Date.now()}.csv`);
  });

  document.getElementById('regenUsers').addEventListener('click', ()=> {
    users = (function makeUsers(n=36){
      const NAMES = ["Aarav","Ishaan","Diya","Vivaan","Anaya","Kavya","Rohan","Sneha","Arjun","Riya","Maya","Karthik","Neha","Sahil","Priya","Vikram"];
      const STATUSES = ["present","absent","late","suspicious"];
      return Array.from({length:n}).map((_,i)=>{
        const name = NAMES[i % NAMES.length] + " " + (100+i);
        const status = STATUSES[Math.floor(Math.random()*STATUSES.length)];
        const obj = {
          id: "U" + (i+1),
          name,
          class: ["A","B","C"][i % 3],
          status,
          trustScore: Math.floor(60 + Math.random()*40),
          avatarUrl: `https://i.pravatar.cc/100?img=${(i%70)+1}`
        };
        if(status === 'present') obj.presentMarkedDate = todayISO();
        return obj;
      });
    })();
    renderCurrentPage();
  });

  document.getElementById('loadAttendanceBtn').addEventListener('click', async ()=> {
    const rawDate = document.getElementById('attendanceDate').value;
    const classFilter = document.getElementById('attendanceClass').value;
    if (!rawDate) {
      alert('Please select a date first');
      return;
    }
    const isoDate = getISODateFromInput(rawDate);
    if(!isoDate){
      alert('Could not parse the selected date. Please choose a valid date from the picker.' );
      return;
    }
    try {
      const loadBtn = document.getElementById('loadAttendanceBtn');
      const originalText = loadBtn.innerText;
      loadBtn.innerText = 'Loading...';
      loadBtn.disabled = true;
      loadBtn.classList.add('btn-loading');

      await loadAttendanceForDateAndClass(isoDate, classFilter);
      try { document.getElementById('attendanceDate').value = isoDate; } catch(e){}

      attendancePinned = true;
      pinnedAttendanceDate = isoDate;
      pinnedAttendanceClass = classFilter || 'all';

      try {
        localStorage.setItem('pa_attendance_pinned', '1');
        localStorage.setItem('pa_attendance_date', String(pinnedAttendanceDate));
        localStorage.setItem('pa_attendance_class', String(pinnedAttendanceClass));
      } catch(e){ console.warn('persist pin failed', e); }

      try { const unpinBtn = document.getElementById('attendanceUnpinBtn'); if(unpinBtn){ unpinBtn.style.display = 'inline-block'; } } catch(e){}

      try { showPage('page-attendance'); } catch(e){}
      renderAttendanceList();

      loadBtn.innerText = originalText;
      loadBtn.disabled = false;
      loadBtn.classList.remove('btn-loading');
    } catch (error) {
      console.error('Error loading attendance:', error);
      alert('Failed to load attendance. Please try again.');
      attendancePinned = false;
      pinnedAttendanceDate = null;
      pinnedAttendanceClass = 'all';
      const loadBtn = document.getElementById('loadAttendanceBtn');
      loadBtn.innerText = 'Load';
      loadBtn.disabled = false;
      loadBtn.classList.remove('btn-loading');
    }
  });

  document.getElementById('refreshInsight').addEventListener('click', ()=> {
    const t = document.getElementById('insightTime');
    t.innerText = 'Refreshing...';
    setTimeout(()=> showAnalyticsDetail(selectedAnalyticsId), 400);
  });

  document.getElementById('improveScore').addEventListener('click', ()=> alert("Tip: run verification & audits to improve trust score. (Demo)"));

  document.getElementById('attendanceExportBtn').addEventListener('click', ()=> {
    const classSel = document.getElementById('attendanceClass').value || 'all';
    const dateIso = getISODateFromInput(document.getElementById('attendanceDate').value || new Date());
    const filtered = users.filter(u => classSel === 'all' || (u.class || '') === classSel);

    if (!filtered.length) {
      alert('No attendance data to export');
      return;
    }

    const rows = filtered.map(u => ({
      id: u.id,
      name: u.name,
      class: u.class || '',
      status: u.status || 'absent',
      trust: u.trustScore || 0,
      date: dateIso
    }));

    exportCSV(rows, `attendance_${classSel}_${dateIso}.csv`);
  });

  function initWebsocket(){
    try {
      let wsUrl;
      try {
        if (API_BASE && (API_BASE.startsWith('http://') || API_BASE.startsWith('https://'))) {
          wsUrl = API_BASE.replace(/^http/, 'ws').replace(/\/$/, '') + '/ws/events';
        } else {
          const proto = location.protocol === 'https:' ? 'wss' : 'ws';
          wsUrl = `${proto}://${location.hostname}${location.port ? ':' + location.port : ''}/ws/events`;
        }
      } catch (e) {
        const proto = location.protocol === 'https:' ? 'wss' : 'ws';
        wsUrl = `${proto}://${location.hostname}${location.port ? ':' + location.port : ''}/ws/events`;
      }

      const token = getToken();
      if(token) wsUrl += (wsUrl.includes('?') ? '&' : '?') + 'token=' + encodeURIComponent(token);

      const ws = new WebSocket(wsUrl);
      window.pa_ws = ws;
      ws.onopen = ()=> console.log("WS connected", wsUrl);

      ws.onmessage = (ev)=> {
        try{
          const m = JSON.parse(ev.data);
          if(!m) return;

          if(m.type === 'presence' && m.payload){
            const p = m.payload;
            try {
              updateUserPresence(p);
            } catch(err){
              console.warn('updateUserPresence failed', err);
              safeLoadUsersOnce();
            }
            return;
          }
          if(m.type === 'info' || m.type === 'ack'){
            return;
          }
          if(m.type === 'recognized' && m.student_id){
            updateUserPresence({ student_id: m.student_id, status: 'Present', timestamp: new Date().toISOString(), confidence: m.confidence || 0 });
            return;
          }

        } catch (e) {
          console.warn("WS parse", e);
        }
      };

      ws.onclose = ()=> { window.pa_ws = null; console.log('WS closed'); };
      ws.onerror = (err)=> console.warn("WS error", err);
    } catch(e){ console.warn('init websocket failed', e); }
  }

  function getISODateFromInput(val){
    if(!val) return formatDateForAPI(new Date());
    if(typeof val === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(val)) return val;
    const dt = new Date(val);
    if(isNaN(dt)) return formatDateForAPI(new Date());
    return dt.toISOString().slice(0,10);
  }

  function formatDateForAPI(dateString){
    if(!dateString) return null;
    if(dateString instanceof Date){
      const y = dateString.getFullYear();
      const m = String(dateString.getMonth()+1).padStart(2,'0');
      const d = String(dateString.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    const parts = String(dateString).split('-').map(s=>s.trim());
    if(parts.length === 3){
      const [d,m,y] = parts;
      if(y.length === 4) return `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
    }
    const dt = new Date(dateString);
    if(!isNaN(dt)) return formatDateForAPI(dt);
    return null;
  }

  async function loadAttendanceForDateAndClass(dateInput, classFilter='all'){
    const iso = getISODateFromInput(dateInput);
    if(!iso) {
      console.warn('Invalid date for attendance load', dateInput);
      return;
    }
    const classParam = (classFilter && classFilter !== 'all') ? `&class=${encodeURIComponent(classFilter)}` : '';
    try {
      const body = await apiFetch(`/api/attendance?date=${encodeURIComponent(iso)}${classParam}`);
      const records = Array.isArray(body) ? body : (body && body.attendance ? body.attendance : []);
      if(records && records.length){
        try {
          pinnedAttendanceRecords = {};
          for(const r of records){
            const sid = String(r.student_id || r.id || r.studentId || '').trim();
            if(!sid) continue;
            const status = (r.status || r.state || r.label || 'present').toString().toLowerCase();
            pinnedAttendanceRecords[sid] = status;
          }
        } catch(e){ console.warn('build pinnedAttendanceRecords failed', e); }

        applyAttendanceToUsers(records);
        document.getElementById('attendanceTitle').innerText = `${(classFilter==='all' ? 'All classes' : 'Class ' + classFilter)} • ${iso}`;
      } else {
        document.getElementById('attendanceTitle').innerText = `${(classFilter==='all' ? 'All classes' : 'Class ' + classFilter)} • ${iso} (No records)`;
        document.getElementById('attendanceList').innerHTML = `<div style="color:var(--muted)">No attendance records for ${iso}.</div>`;
      }
    } catch (err){
      console.error('Failed to load attendance for date', iso, err);
      alert('Failed to load attendance for date. See console.');
    }
  }

  function renderAttendanceList(){
    const classSel = (attendancePinned && pinnedAttendanceClass) ? pinnedAttendanceClass : (document.getElementById('attendanceClass').value || 'all');
    const iso = (attendancePinned && pinnedAttendanceDate) ? pinnedAttendanceDate : getISODateFromInput(document.getElementById('attendanceDate').value || new Date());
    const listEl = document.getElementById('attendanceList');
    const filtered = users.filter(u => classSel === 'all' || (u.class || '') === classSel);

    if(!filtered.length){
      listEl.innerHTML = `<div style="color:var(--muted)">No students found for ${classSel}</div>`;
      return;
    }

    listEl.innerHTML = filtered.map(u => {
      const pinnedStatus = getPinnedStatusForUser(u);
      const status = (pinnedStatus ? String(pinnedStatus) : (u.status || 'absent')).toLowerCase();
      const avatarField = u.photo || u.photo_url || u.avatar || u.avatarUrl || u.avatar_url || '';
      const avatarSrc = normalizeAvatarUrl(avatarField || u.avatarUrl || u.avatar_url);
      const onerr = `this.onerror=null;this.src='${API_BASE.replace(/\/$/,'')}/avatars/default.jpg'`;
      // meet-style tile
      return `
        <div class="presence-card meet status-${status}" data-id="${u.id}">
          <div class="meet-avatar"><img src="${avatarSrc}" alt="${u.name}" onerror="${onerr}"></div>
          <div class="meet-body">
            <div class="meet-head">
              <div style="min-width:0;">
                <div class="meet-name">${u.name}</div>
                <div class="meet-meta">${u.class || ''} ${u.student_id ? ' • ' + u.student_id : ''}</div>
              </div>
              <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
                <div class="status ${status}">${status}</div>
                <div class="small muted live-seen-at">${u.liveSeenAt ? new Date(u.liveSeenAt).toLocaleTimeString() : ''}</div>
              </div>
            </div>
            <div class="meet-actions">
              ${canMark() ? `<button class="btn-mark primary att-mark-btn" data-id="${u.id}" data-date="${iso}">Mark Present</button>` : ''}
              ${isHod() ? `<button class="btn-mark att-del-btn" data-id="${u.id}">Delete</button>` : ''}
            </div>
          </div>
        </div>
      `;
    }).join('');

    // attach handlers for meet-tiles
    document.querySelectorAll('.att-mark-btn').forEach(btn => {
      btn.onclick = async () => {
        btn.disabled = true;
        const studentId = btn.dataset.id;
        const dateIso = btn.dataset.date || iso;
        try {
          await apiFetch('/api/attendance/mark', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ student_id: studentId, status: 'Present', date: dateIso })
          });
          updateUserPresence({ student_id: studentId, status: 'present', timestamp: new Date().toISOString() });
          try {
            if(attendancePinned){
              const keys = [String(studentId)];
              const u = users.find(x => String(x.id) === String(studentId) || String(x.student_id) === String(studentId));
              if(u){
                if(u.name) keys.push(normalizeNameKey(u.name));
                if(u.studentId) keys.push(String(u.studentId));
              }
              for(const k of keys){ if(k) pinnedAttendanceRecords[String(k)] = 'present'; }
            }
          } catch(e){}
        } catch (e){
          console.warn('Mark attendance error', e);
          alert('Failed to mark attendance.');
        } finally { btn.disabled = false; }
      };
    });

    document.querySelectorAll('.att-del-btn').forEach(btn => {
      btn.onclick = async () => {
        const id = btn.dataset.id;
        if(!confirm(`Delete student ${id}? This will remove attendance & trust records.`)) return;
        try {
          const res = await apiFetch(`/api/students/${encodeURIComponent(id)}`, { method: 'DELETE' });
          if(res && (res.success || res.deleted)){
            await loadUsers();
            renderAttendanceList();
          } else {
            alert('Delete failed: ' + (res && res.detail ? res.detail : JSON.stringify(res)));
          }
        } catch (err){
          console.warn('delete error', err);
          alert('Delete failed');
        }
      };
    });
  }

  function wirePresenceButtons(){
    document.querySelectorAll('.mark-btn').forEach(btn=>{
      btn.onclick = async (e) => {
        const id = btn.dataset.id;
        btn.disabled = true;
        try {
          await apiFetch('/api/simulate-checkin', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ student_id: id, status: 'Present' })
          });
          await loadUsers();
        } catch (err){
          console.warn('mark error', err);
          alert('Mark failed');
        } finally {
          btn.disabled = false;
        }
      };
    });

    document.querySelectorAll('.del-btn').forEach(btn=>{
      btn.onclick = async (e) => {
        const id = btn.dataset.id;
        if(!confirm(`Delete student ${id}? This will remove attendance & trust records.`)) return;
        try {
          const res = await apiFetch(`/api/students/${encodeURIComponent(id)}`, { method: 'DELETE' });
          if(res && (res.success || res.deleted)){
            await loadUsers();
          } else {
            alert('Delete failed: ' + (res && res.detail ? res.detail : JSON.stringify(res)));
          }
        } catch (err){
          console.warn('delete error', err);
          alert('Delete failed');
        }
      };
    });
  }

  // modal wiring (sign in / add)
  document.getElementById('openSign').addEventListener('click', ()=> {
    document.getElementById('signMsg').innerText = '';
    document.getElementById('signModal').style.display = 'block';
  });
  document.getElementById('cancelSign').addEventListener('click', ()=> { document.getElementById('signModal').style.display = 'none'; });

  document.getElementById('addStudentBtn').addEventListener('click', ()=> {
    document.getElementById('addMsg').innerText = '';
    document.getElementById('addId').value = '';
    document.getElementById('addName').value = '';
    document.getElementById('addClass').value = '';
    document.getElementById('addMobile').value = '';
    document.getElementById('addModal').style.display = 'block';
  });
  document.getElementById('cancelAdd').addEventListener('click', ()=> { document.getElementById('addModal').style.display = 'none'; });

  document.getElementById('doSign').addEventListener('click', async ()=> {
    const username = document.getElementById('signUser').value.trim();
    const password = document.getElementById('signPass').value.trim();
    const msgEl = document.getElementById('signMsg');
    msgEl.style.color = 'var(--muted)';
    if(!username || !password){ msgEl.innerText = 'Enter username & password'; return; }

    try {
      const j = await apiFetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });

      if (j && j.token) {
        localStorage.setItem('pa_token', j.token);
        localStorage.setItem('pa_role', j.role || 'teacher');
        localStorage.setItem('pa_user', j.display_name || username);
        if (j.student_id) localStorage.setItem('pa_student_id', j.student_id);
        msgEl.style.color = 'green';
        msgEl.innerText = 'Signed in';
        document.getElementById('signedUser').innerText = j.display_name || username;
        document.getElementById('roleBadge').innerText = (j.role || 'teacher');
        document.getElementById('signModal').style.display = 'none';
        toggleRoleControls();
        await loadUsers();

        try {
          if (window.pa_ws) {
            try { window.pa_ws.close(); } catch(e){}
            window.pa_ws = null;
          }
          setTimeout(initWebsocket, 120);
        } catch(e){ console.warn('reinit ws after login failed', e); }

      } else {
        msgEl.style.color = '#ef4444';
        msgEl.innerText = (j && (j.detail || j.message)) ? (j.detail || j.message) : 'Login failed';
      }
    } catch (e) {
      console.warn('login error', e);
      msgEl.style.color = '#ef4444';
      msgEl.innerText = 'Login error';
    }
  });

  document.getElementById('saveAdd').addEventListener('click', async ()=> {
    const id = document.getElementById('addId').value.trim();
    const name = document.getElementById('addName').value.trim();
    const cls = (document.getElementById('addClass').value || '').trim();
    const mobile = (document.getElementById('addMobile').value || '').trim();
    const avatar = document.getElementById('addAvatar').files[0];
    const face = document.getElementById('addFace').files[0];
    const msgEl = document.getElementById('addMsg');
    msgEl.style.color = 'var(--muted)';
    if(!id || !name){ msgEl.style.color = '#ef4444'; msgEl.innerText = 'ID and Name required'; return; }

    const fd = new FormData();
    fd.append('student_id', id);
    fd.append('name', name);
    fd.append('class_name', cls || 'A');
    fd.append('mobile', mobile || '');
    if(avatar) fd.append('avatar', avatar);
    if(face) fd.append('face', face);

    try {
      const headers = localStorage.getItem('pa_token') ? { 'Authorization': 'Bearer ' + localStorage.getItem('pa_token') } : {};
      const j = await apiFetch('/api/students', {
        method: 'POST',
        headers,
        body: fd
      });

      if(j && (j.success || j.created)){
        msgEl.style.color = 'green';
        msgEl.innerText = 'Student added';
        document.getElementById('addModal').style.display = 'none';
        await loadUsers();
      } else {
        msgEl.style.color = '#ef4444';
        msgEl.innerText = (j && j.detail) ? j.detail : JSON.stringify(j);
      }
    } catch (e){
      console.warn('add student error', e);
      msgEl.style.color = '#ef4444';
      msgEl.innerText = 'Server error';
    }
  });

  function renderCurrentPage(){
    document.getElementById('signedUser').innerText = localStorage.getItem('pa_user') || 'Guest';
    document.getElementById('roleBadge').innerText = (localStorage.getItem('pa_role') || 'Guest').toUpperCase();

    if(attendancePinned){
      document.querySelectorAll('.nav-link').forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
      const btn = document.querySelector(`.nav-link[data-page="page-attendance"]`);
      if(btn){ btn.classList.add('active'); btn.setAttribute('aria-pressed','true'); }
      showPage('page-attendance');
      return;
    }

    const active = document.querySelector('.nav-link.active');
    const pageId = active ? active.dataset.page : 'page-dashboard';
    showPage(pageId);
  }

  // single initialiser
  (function init(){
    toggleRoleControls();

    try {
      if(localStorage.getItem('pa_attendance_pinned')){
        attendancePinned = true;
        pinnedAttendanceDate = localStorage.getItem('pa_attendance_date') || null;
        pinnedAttendanceClass = localStorage.getItem('pa_attendance_class') || 'all';
        try { const unpinBtn = document.getElementById('attendanceUnpinBtn'); if(unpinBtn) unpinBtn.style.display = 'inline-block'; } catch(e){}
      }
    } catch(e){ console.warn('rehydrate pin failed', e); }

    loadUsers();
    initWebsocket();

    // periodic refresh (single interval)
    setInterval(loadUsers, 8000);

    // single resize handler for charts
    window.addEventListener('resize', ()=> {
      if(selectedAnalyticsId) showAnalyticsDetail(selectedAnalyticsId);
    });
  })();

  // ensure charts resize on window resize (no duplicate listener)
  window.addEventListener('resize', ()=> {
    const active = document.querySelector('.page.active');
    if(active && active.id === 'page-insights'){ if(selectedAnalyticsId) showAnalyticsDetail(selectedAnalyticsId); }
  });

  function isHod(){ return (localStorage.getItem('pa_role') === 'hod'); }
  function isTeacher(){ return (localStorage.getItem('pa_role') === 'teacher'); }
  function isParent(){ return (localStorage.getItem('pa_role') === 'parent'); }
  function canMark(){ return isHod() || isTeacher(); }

  function toggleRoleControls(){
    const addBtn = document.getElementById('addStudentBtn');
    const role = localStorage.getItem('pa_role') || 'guest';
    document.getElementById('signedUser').innerText = localStorage.getItem('pa_user') || 'Guest';
    document.getElementById('roleBadge').innerText = role.charAt(0).toUpperCase() + role.slice(1);
    if(role === 'hod'){
      addBtn.style.display = 'inline-block';
      document.getElementById('openSign').style.display = 'none';
      document.getElementById('signOut').style.display = 'inline-block';
    } else if(role === 'teacher'){
      addBtn.style.display = 'none';
      document.getElementById('openSign').style.display = 'none';
      document.getElementById('signOut').style.display = 'inline-block';
    } else if(role === 'parent'){
      addBtn.style.display = 'none';
      document.getElementById('openSign').style.display = 'none';
      document.getElementById('signOut').style.display = 'inline-block';
    } else {
      addBtn.style.display = 'none';
      document.getElementById('openSign').style.display = 'inline-block';
      document.getElementById('signOut').style.display = 'none';
    }
  }

  document.getElementById('signOut').addEventListener('click', ()=> {
    localStorage.removeItem('pa_token');
    localStorage.removeItem('pa_role');
    localStorage.removeItem('pa_user');
    localStorage.removeItem('pa_student_id');
    document.getElementById('signedUser').innerText = 'Guest';
    document.getElementById('roleBadge').innerText = 'Guest';
    toggleRoleControls();
    loadUsers();
  });

  </script>
</body>
</html>

