<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PresenceAI — Unified Demo</title>
  <style>
    /* Dark, colorful theme with lively animations and preserved layout */
    :root{
      --bg-1: #061023;            /* deep navy */
      --bg-2: #071827;            /* slightly lighter */
      --muted: #98a6b8;           /* muted text */
      --card: rgba(255,255,255,0.02);
      --accent1: #00FFC2;         /* neon mint */
      --accent2: #4F6CFF;         /* electric blue */
      --accent3: #FF6EC7;         /* pink */
      --glass: rgba(255,255,255,0.03);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: #e6f7ff;
      display: flex;
      background:
        radial-gradient(1200px 600px at 10% 8%, rgba(79,108,255,0.08), transparent),
        radial-gradient(900px 400px at 90% 92%, rgba(255,110,199,0.04), transparent),
        linear-gradient(180deg, var(--bg-1), var(--bg-2) 800px);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      min-height: 100vh;
    }

    /* Animations */
    @keyframes fadeInUp {
      from { transform: translateY(12px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes pulseGlow {
      0% { box-shadow: 0 0 6px rgba(79,108,255,0.06); }
      50% { box-shadow: 0 0 20px rgba(79,108,255,0.12); }
      100% { box-shadow: 0 0 6px rgba(79,108,255,0.06); }
    }
    @keyframes pulseBadge {
      0% { transform: scale(1); opacity:1; }
      50% { transform: scale(1.04); opacity:0.92; }
      100% { transform: scale(1); opacity:1; }
    }

    /* SIDEBAR */
    .sidebar {
      width: 280px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
      border-right: 1px solid rgba(255,255,255,0.03);
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      gap: 0.7rem;
      position: relative;
      backdrop-filter: blur(6px);
    }

    .logo {
      background: linear-gradient(135deg,var(--accent2), var(--accent3));
      color: #071827;
      font-weight: 900;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 14px;
      font-size: 1.05rem;
      margin-bottom: .6rem;
      box-shadow: 0 10px 36px rgba(79,108,255,0.12);
      animation: fadeInUp .5s ease both;
    }

    .title { margin: 0 0 0.5rem; font-size: 1.1rem; letter-spacing: 0.2px; color: #e6f7ff; }

    .class-selector {
      margin-bottom: 1rem;
      padding: 0.6rem;
      border: 1px solid rgba(255,255,255,0.03);
      border-radius: 10px;
      background: transparent;
      font-weight:700;
      color:var(--muted);
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .class-selector:focus { transform: translateY(-4px); box-shadow: 0 14px 40px rgba(0,255,194,0.06); outline:none; }

    .nav {
      display: flex;
      flex-direction: column;
      gap: 0.55rem;
      flex-grow: 1;
    }

    .nav-link {
      padding: 0.8rem;
      text-align: left;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      background: transparent;
      font-weight: 800;
      color: #cfe9ff;
      display:flex;
      align-items:center;
      gap:10px;
      transition: all .22s cubic-bezier(.2,.9,.3,1);
      position: relative;
      overflow: hidden;
    }

    .nav-link::after{
      content:'';
      position:absolute;
      left:10px; top:12px; bottom:12px;
      width:6px;
      background: linear-gradient(180deg,var(--accent1),var(--accent2));
      transform: scaleY(0);
      transform-origin: top;
      transition: transform .22s ease;
      border-radius:6px;
      opacity:0.98;
    }

    .nav-link:hover { transform: translateX(8px); }
    .nav-link.active {
      background: linear-gradient(90deg, rgba(0,255,194,0.06), rgba(79,108,255,0.04));
      color: #ffffff;
      box-shadow: 0 8px 30px rgba(79,108,255,0.06);
      animation: pulseGlow 3s infinite;
    }
    .nav-link.active::after { transform: scaleY(1); }

    .legend {
      margin-top: 1.1rem;
      font-size: 0.85rem;
      color: var(--muted);
      line-height:1.6;
    }
    .legend .dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 0.5rem;
    }
    .legend .present { background: linear-gradient(90deg,#34d399,#10b981); }
    .legend .absent { background: linear-gradient(90deg,#fb7185,#ef4444); }
    .legend .late { background: linear-gradient(90deg,#f59e0b,#f97316); }
    .legend .suspicious { background: linear-gradient(90deg,#f472b6,#ef4444); }

    /* MAIN */
    .main {
      flex-grow: 1;
      padding: 28px;
      overflow-y: auto;
    }

    .page { display: none; animation: fadeInUp .28s ease-in-out; }
    .page.active { display: block; }

    .page-header { margin-bottom: 1.25rem; display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .page-header h1 { margin:0; font-size:1.3rem; color:#e9f6ff; }

    .stats {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 8px 28px rgba(2,6,23,0.6);
      flex: 1;
      font-size: 1rem;
      font-weight: 700;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:.5rem;
      transition: transform .18s ease, box-shadow .18s ease;
      border: 1px solid rgba(255,255,255,0.02);
    }
    .stat-card:hover { transform: translateY(-6px) scale(1.01); box-shadow: 0 20px 50px rgba(79,108,255,0.06); }
    .stat-card .number { font-size:1.35rem; color:var(--accent2); font-weight:900; }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }

    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.015));
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 8px 28px rgba(2,6,23,0.55);
      transition: transform .18s ease;
      border:1px solid rgba(255,255,255,0.02);
      animation: fadeInUp .48s ease both;
    }
    .card h3 { margin:0 0 8px 0; color:#eafaff; }

    /* Buttons */
    .btn-primary {
      margin-top: 1rem;
      padding: 0.6rem 1rem;
      border: none;
      border-radius: 10px;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      color: #071827;
      font-weight: 800;
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease;
      box-shadow: 0 10px 30px rgba(0,255,194,0.06);
    }
    .btn-primary:hover { transform: translateY(-3px); }
    .btn-ghost {
      padding: 0.5rem 0.8rem;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,0.04);
      background: transparent;
      cursor:pointer;
      font-weight:800;
      color:#dff4ff;
    }

    /* Presence Map */
    .presence-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1rem;
    }

    .presence-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
      border-radius: 14px;
      padding: 0.9rem;
      text-align: center;
      box-shadow: 0 10px 36px rgba(2,6,23,0.6);
      transition: transform 0.32s cubic-bezier(.2,.9,.3,1), box-shadow 0.22s;
      will-change: transform;
      border: 1px solid rgba(255,255,255,0.02);
    }
    .presence-card:hover { transform: translateY(-10px) scale(1.02); box-shadow: 0 28px 64px rgba(79,108,255,0.08); }

    .presence-card img {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      margin-bottom: 0.5rem;
      border: 2px solid rgba(255,255,255,0.03);
      box-shadow: 0 6px 18px rgba(79,108,255,0.06);
      transition: transform .22s ease;
      object-fit: cover;
    }

    .presence-card .status {
      font-size: 0.78rem;
      margin-top: 0.25rem;
      display: inline-block;
      padding: 6px 12px;
      border-radius: 999px;
      color: #061226;
      text-transform: capitalize;
      font-weight:900;
    }

    .presence-card .name {
      font-weight:800;
      margin-bottom:6px;
      font-size:0.98rem;
      color:#f0fbff;
    }

    .presence-card .text-sm { color:var(--muted); font-weight:700; }

    .status.present { background: linear-gradient(90deg,#7ef9c8,#34d399); }
    .status.absent { background: linear-gradient(90deg,#ff99a8,#ff6b81); }
    .status.late { background: linear-gradient(90deg,#ffd27a,#f97316); }
    .status.suspicious { background: linear-gradient(90deg,#ff7ac1,#ef4444); }

    /* Leaderboard */
    .leaderboard { margin-top: 1rem; font-size: 0.95rem; color:#dff6ff; }
    .leaderboard div { display:flex; justify-content:space-between; padding:0.4rem 0; border-bottom: 1px solid rgba(255,255,255,0.02); align-items:center; }

    /* Timeline */
    .timeline-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
    .timeline-entry { background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02)); padding: 1rem; border-radius: 12px; box-shadow: 0 8px 28px rgba(2,6,23,0.5); font-size: 0.95rem; color:#e6f7ff; }

    /* Trust Score Layout */
    .trust-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    .top-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; margin-top: 1rem; }
    .top-card { background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02)); border-radius: 12px; padding: 0.75rem; text-align: center; box-shadow: 0 8px 28px rgba(2,6,23,0.55); transition: transform .18s ease; }
    .top-card:hover { transform: translateY(-8px); box-shadow: 0 26px 64px rgba(79,108,255,0.06); }
    .top-card img { width:56px; height:56px; border-radius:999px; margin-bottom:8px; border:2px solid rgba(255,255,255,0.02); }
    .top-card .score { margin-top: 0.25rem; font-size: 0.95rem; color: var(--accent1); font-weight:900; }

    .scrollable { max-height: 420px; overflow-y: auto; border-top: 1px solid rgba(255,255,255,0.02); margin-top: 1rem; padding-top: 8px; }

    /* Insights page layout */
    .insights-container { display: grid; grid-template-columns: 380px 1fr; gap: 1.5rem; align-items: start; }
    .analytics-list { background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.015)); padding: 12px; border-radius: 12px; box-shadow: 0 8px 28px rgba(2,6,23,0.55); max-height: calc(100vh - 170px); overflow-y: auto; }

    .searchbox { display:flex; gap:8px; align-items:center; margin-bottom:10px; }
    .searchbox input { flex:1; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); background: transparent; color:#eaf8ff; font-weight:700; }

    .analytics-item {
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      display:flex;
      gap:10px;
      align-items:center;
      transition: transform .15s ease, box-shadow .15s ease;
      border:1px solid transparent;
      background: linear-gradient(90deg, rgba(79,108,255,0.02), rgba(255,110,199,0.02));
    }
    .analytics-item:hover { transform: translateY(-6px); box-shadow: 0 16px 40px rgba(79,108,255,0.06); }
    .analytics-item.selected { border-color: rgba(79,108,255,0.14); box-shadow: 0 22px 56px rgba(79,108,255,0.07); }

    .analytics-item .meta { flex:1; }
    .analytics-title { font-weight:900; font-size:0.96rem; color:#eaffff; }
    .analytics-desc { font-size:0.84rem; color:var(--muted); margin-top:4px; }

    .analytics-badge { background: linear-gradient(90deg,var(--accent1),var(--accent2)); color:#071827; padding:6px 8px; border-radius:999px; font-weight:900; font-size:0.85rem; min-width:48px; text-align:center; box-shadow: 0 10px 28px rgba(0,255,194,0.06); }

    .insights-right { background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02)); padding: 14px; border-radius: 12px; box-shadow: 0 8px 28px rgba(2,6,23,0.55); display:flex; flex-direction:column; gap:12px; max-height: calc(100vh - 112px); overflow-y: auto; }

    .chart-card { background: transparent; padding: 12px; border-radius: 10px; box-shadow: 0 8px 28px rgba(2,6,23,0.35); display:flex; flex-direction:column; gap:10px; }
    .chart-large { height:320px; overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .chart-small { height:320px; overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .chart-large canvas, .chart-small canvas { width:100%; height:100%; display:block; border-radius:8px; }

    .analytics-details { margin-top: 6px; display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    .details-card { background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02)); padding:12px; border-radius:10px; box-shadow: 0 8px 28px rgba(2,6,23,0.03); width: calc(50% - 6px); color:#e8fbff; }
    .details-card h4 { margin:0 0 8px 0; font-size:0.95rem; }
    .small-list { font-size:0.9rem; color:var(--muted); }
    .small-list div { padding:6px 0; display:flex; justify-content:space-between; border-bottom: 1px dashed rgba(255,255,255,0.02); }

    /* Trust card layout inside insights */
    .trust-card { display:grid; grid-template-columns: 1fr 1fr; gap:12px; align-items:center; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02)); padding: 14px; border-radius: 12px; box-shadow: 0 14px 40px rgba(2,6,23,0.56); }
    .trust-big { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; color:#e6f7ff; }
    .trust-number { font-size:48px; font-weight:900; color: var(--accent2); }
    .trust-sub { color:var(--muted); font-weight:700; }

    .tips-list { display:flex; flex-direction:column; gap:8px; }
    .tip { padding:10px; border-radius:10px; background: linear-gradient(90deg, rgba(79,108,255,0.06), rgba(0,255,194,0.02)); font-weight:800; color:#eaffff; }

    .controls { display:flex; gap:8px; align-items:center; }

    .live-badge { display:inline-block; padding:6px 8px; border-radius:999px; background: linear-gradient(90deg,#ff7a7a, #ffb27a); color:white; font-weight:900; animation: pulseBadge 2s infinite ease-in-out; }

    .muted { color:var(--muted); font-weight:700; }

    /* scrollbars */
    .insights-right::-webkit-scrollbar { width:10px; }
    .insights-right::-webkit-scrollbar-thumb { background: linear-gradient(180deg,#0d2f44,#0a2740); border-radius:8px; }
    .analytics-list::-webkit-scrollbar { width:8px; }
    .analytics-list::-webkit-scrollbar-thumb { background:#0d2636; border-radius:8px; }

    /* modal style */
    .modal {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.03));
      color: #e6f7ff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(2,6,23,0.6);
      z-index: 200;
      display: none;
      width: 460px;
      max-width: 96%;
      border: 1px solid rgba(255,255,255,0.03);
    }
    .modal h3 { margin: 0 0 8px 0; color:#eaffff; }
    .modal label { display:block; margin-top:8px; color:var(--muted); font-weight:700; }
    .modal input, .modal select { width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); margin-top:6px; background: transparent; color:#eaffff; }
    .modal .muted { color: var(--muted); }
    .modal .row { display:flex; gap:8px; }
    .modal .row .col { flex:1; }

    .top-right { position: absolute; right: 18px; top: 18px; display:flex; gap:8px; align-items:center; }

    .badge {
      background: linear-gradient(90deg,var(--accent1),var(--accent2));
      color: #071827;
      padding:6px 10px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 12px;
      box-shadow: 0 10px 30px rgba(0,255,194,0.06);
    }

    /* responsive tweaks */
    @media (max-width: 1100px){
      .insights-container { grid-template-columns: 1fr; }
      .charts-row { grid-template-columns: 1fr; }
      .details-card { width:100%; }
      .trust-card { grid-template-columns: 1fr; }
      .sidebar { width: 100px; padding: 12px; }
    }

    /* respect reduced motion */
    @media (prefers-reduced-motion: reduce){
      * { animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition-duration: 0.001ms !important; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar">
    <div class="logo">PA</div>
    <h2 class="title">PresenceAI</h2>
    <select id="classSelector" class="class-selector" aria-label="Filter by class">
      <option value="all">All Classes</option>
      <option value="A">Class A</option>
      <option value="B">Class B</option>
      <option value="C">Class C</option>
    </select>
    <nav class="nav" role="navigation">
      <button data-page="page-dashboard" class="nav-link active" aria-pressed="true">Dashboard</button>
      <button data-page="page-presence" class="nav-link" aria-pressed="false">Presence Map</button>
      <button data-page="page-timeline" class="nav-link" aria-pressed="false">Timeline</button>
      <button data-page="page-trust" class="nav-link" aria-pressed="false">Trust Score</button>
      <button data-page="page-insights" class="nav-link">Insights</button>
    </nav>
    <div class="legend" aria-hidden="true">
      <p><span class="dot present"></span> Present</p>
      <p><span class="dot absent"></span> Absent</p>
      <p><span class="dot late"></span> Late</p>
      <p><span class="dot suspicious"></span> Suspicious</p>
    </div>
    <div style="margin-top:auto">
      <div style="font-weight:700">Signed in as</div>
      <div id="signedUser" style="margin-top:6px; font-weight:800">Guest</div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="openSign" class="btn-ghost">Sign In</button>
        <button id="signOut" class="btn-ghost" style="display:none">Sign Out</button>
      </div>
    </div>
  </aside>

  <!-- Main content -->
  <main id="mainContent" class="main">
    <!-- Dashboard Page -->
    <section id="page-dashboard" class="page active" aria-live="polite">
      <header class="page-header">
        <h1>Dashboard</h1>
        <div style="display:flex;align-items:center;gap:12px">
          <div class="badge" id="roleBadge">Guest</div>
          <div class="controls">
            <button id="regenUsers" class="btn-ghost" title="Regenerate sample data">Regenerate</button>
            <button id="downloadSnapshot" class="btn-ghost" title="Download CSV snapshot">Export CSV</button>
          </div>
        </div>
      </header>
      <div class="stats">
        <div class="stat-card">Present <span id="stat-present" class="number">0</span></div>
        <div class="stat-card">Absent <span id="stat-absent" class="number">0</span></div>
        <div class="stat-card">Late <span id="stat-late" class="number">0</span></div>
      </div>
      <div class="grid-2">
        <div class="card">
          <h3>Quick Presence Preview</h3>
          <div id="presencePreview" class="presence-grid" style="margin-top:12px;"></div>
          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <button id="openPresence" class="btn-primary">Open Full Map</button>
            <button id="addStudentBtn" class="btn-ghost" style="display:none">Add Student</button>
          </div>
        </div>
        <div class="card">
          <h3>Leader board</h3>
          <div id="leaderboard" class="leaderboard"></div>
        </div>
      </div>
    </section>

    <!-- Presence Map Page -->
    <section id="page-presence" class="page" aria-hidden="true">
      <header class="page-header"><h1>Presence Map</h1></header>
      <div id="presenceMap" class="presence-grid"></div>
    </section>

    <!-- Timeline Page -->
    <section id="page-timeline" class="page" aria-hidden="true">
      <header class="page-header"><h1>Timeline</h1></header>
      <div id="timeline" class="timeline-grid"></div>
    </section>

    <!-- Trust Score Page -->
    <section id="page-trust" class="page" aria-hidden="true">
      <header class="page-header"><h1>Trust Score</h1></header>
      <div class="trust-layout">
        <div class="trust-top">
          <h3>Top Students</h3>
          <div id="trustTopGrid" class="top-grid"></div>
        </div>

        <div class="trust-list">
          <h3>All Students</h3>
          <div id="trustLeaderboard" class="leaderboard scrollable"></div>
        </div>
      </div>
    </section>

    <!-- Insights Page -->
    <section id="page-insights" class="page" aria-hidden="true">
      <header class="page-header"><h1>Insights</h1></header>

      <div class="insights-container">
        <!-- Left: AI Analytics list (scrollable) -->
        <div class="analytics-list" id="analyticsList">
          <div class="searchbox">
            <input id="analyticsSearch" placeholder="Search analytics..." aria-label="Search analytics"/>
            <div class="analytics-badge live-badge" title="Live">LIVE</div>
          </div>
          <!-- analytics items appended here -->
        </div>

        <!-- Right: detail view (chart + pie + details) -->
        <div class="insights-right" id="insightsRight">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <h3 id="insightTitle" style="margin:0">Select an analysis</h3>
              <div id="insightDesc" style="color:var(--muted); font-size:0.95rem; margin-top:6px;">Click an item on the left to view graphs & breakdowns.</div>
            </div>
            <div style="text-align:right; color:var(--muted); font-weight:600;">
              <div style="font-size:0.85rem; margin-bottom:6px;">Class filter:</div>
              <div id="insightFilterText">All</div>
            </div>
          </div>

          <div class="topbar" style="justify-content:space-between;">
            <div class="controls" style="gap:10px;">
              <button id="refreshInsight" class="btn-ghost">Refresh</button>
              <button id="exportInsightCSV" class="btn-ghost">Export CSV</button>
            </div>
            <div style="color:var(--muted); font-weight:700;">Snapshot • <span id="insightTime">--</span></div>
          </div>

          <!-- Charts row: line + pie (pie has legend to right) -->
          <div class="charts-row" style="margin-top:12px;">
            <div class="chart-card chart-large">
              <canvas id="lineChart" role="img" aria-label="Trend line chart"></canvas>
            </div>
            <div style="display:flex;flex-direction:column;gap:10px;">
              <div class="chart-card chart-small">
                <canvas id="pieChart" role="img" aria-label="Distribution pie chart"></canvas>
              </div>
              <div id="pieLegend" style="margin-top:6px; font-size:0.9rem;"></div>
            </div>
          </div>

          <!-- Trust card + tips below charts -->
          <div style="margin-top:12px;">
            <div class="trust-card">
              <div class="trust-big">
                <div style="font-size:0.95rem;font-weight:800;color:#eafaff">Trust Score</div>
                <div id="trustNumber" class="trust-number">--</div>
                <div id="trustPctDesc" class="trust-sub">Average trust across filtered users</div>
                <div style="margin-top:6px;"><button id="improveScore" class="btn-primary">Improve My Score</button></div>
              </div>
              <div>
                <h4 style="margin:0 0 8px 0;color:#eaffff">AI Tips</h4>
                <div class="tips-list" id="tipsList">
                  <!-- tips appended here -->
                </div>
              </div>
            </div>
          </div>

          <div class="analytics-details" style="margin-top:14px;">
            <div class="details-card">
              <h4>Top students (by trust)</h4>
              <div id="topStudentsList" class="small-list"></div>
            </div>
            <div class="details-card">
              <h4>Quick stats</h4>
              <div id="quickStats" style="font-size:0.95rem; color:var(--muted);"></div>
            </div>
          </div>

        </div>
      </div>
    </section>
  </main>

  <!-- Add student modal -->
  <div id="addModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <h3>Add Student</h3>
    <label for="addId">Student ID</label>
    <input id="addId" placeholder="unique id (e.g. sai)" />
    <label for="addName">Name</label>
    <input id="addName" placeholder="Full name" />
    <label for="addClass">Class</label>
    <input id="addClass" placeholder="A / B / C" />
    <label for="addMobile">Mobile</label>
    <input id="addMobile" placeholder="Mobile (for parent login)" />
    <label for="addAvatar">Avatar (optional)</label>
    <input id="addAvatar" type="file" accept="image/*" />
    <label for="addFace">Face image (optional)</label>
    <input id="addFace" type="file" accept="image/*" />
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="saveAdd" class="btn-primary">Save</button>
      <button id="cancelAdd" class="btn-ghost">Cancel</button>
    </div>
    <div id="addMsg" class="small muted" style="margin-top:8px"></div>
  </div>

  <!-- Sign-in modal -->
  <div id="signModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <h3>Sign In</h3>
    <label for="signRole">Role</label>
    <select id="signRole">
      <option value="hod">HOD</option>
      <option value="teacher">Teacher</option>
      <option value="parent">Parent</option>
    </select>
    <label for="signUser">Username</label>
    <input id="signUser" placeholder="hod / teacher or child's name for parent" />
    <label for="signPass">Password</label>
    <input id="signPass" placeholder="password" />
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="doSign" class="btn-primary">Sign In</button>
      <button id="cancelSign" class="btn-ghost">Cancel</button>
    </div>
    <div id="signMsg" class="small muted" style="margin-top:8px"></div>
  </div>

  <script>
    
  // --- API Base auto-detect ---
  let API_BASE;
  if (location.port === "5500" || location.protocol === "file:") {
    API_BASE = "http://127.0.0.1:8000";
  } else {
    API_BASE = location.origin;
  }
  console.log("Using API_BASE =", API_BASE);


    /* ---------- Client-side JS for dashboard + role logic ---------- */

    // Utility state
    let users = [];
    let selectedClass = "all";
    let selectedAnalyticsId = null;
    const ANALYTICS = [
      { id:'late_month', title:'Late — This Month', description:'Percentage of students marked late (snapshot)', compute: null },
      { id:'punctuality_A', title:'Punctuality — Class A', description:'Punctuality issues for class A', compute: null },
      { id:'consistent_C', title:'Consistent — Class C', description:'Students with high consistency (trust ≥ 85) in Class C', compute: null },
      { id:'suspicious_count', title:'Suspicious activity', description:'Number of flagged suspicious statuses', compute: null },
      { id:'avg_trust', title:'Average Trust', description:'Average trust across the filtered population', compute: null },
      { id:'attendance_rate', title:'Attendance Rate', description:'Estimated present vs absent snapshot', compute: null }
    ];


   // Helpers for fetching (inject token if available)
function getToken() { return localStorage.getItem('pa_token'); }
async function apiFetch(path, opts = {}) {
  opts = opts || {};
  opts.headers = opts.headers || {};
  const t = getToken();
  if (t) opts.headers['Authorization'] = 'Bearer ' + t;

  // ensure path is absolute to API_BASE
  const url = path.startsWith('http') ? path : `${API_BASE}${path.startsWith('/') ? '' : '/'}${path}`;
  const res = await fetch(url, opts);

  const ct = res.headers.get('content-type') || '';
  let body;
  if (ct.includes('application/json')) {
    body = await res.json().catch(()=>null);
  } else {
    body = await res.text().catch(()=>null);
  }
  if (!res.ok) {
    throw body || { message: 'Request failed', status: res.status };
  }
  return body;
}

/* ---------- Avatar URL normalization helper ---------- */
function normalizeAvatarUrl(u) {
  const defaultPath = '/avatars/default.jpg';
  if (!u) {
    return API_BASE.replace(/\/$/, '') + defaultPath;
  }
  if (typeof u === 'object') {
    u = u.avatar || u.avatarUrl || u.avatar_url || u.name || '';
  }
  u = String(u || '');
  u = u.trim();
  if (!u) return API_BASE.replace(/\/$/, '') + defaultPath;
  if (u.startsWith('http://') || u.startsWith('https://') || u.startsWith('data:')) return u;
  if (u.startsWith('/')) return API_BASE.replace(/\/$/, '') + u;
  return API_BASE.replace(/\/$/, '') + '/avatars/' + u;
}

    // single canonical loadUsers
    async function loadUsers(){
      try {
        const data = await apiFetch('/api/students');
        users = Array.isArray(data) ? data : [];
      } catch (e) {
        console.warn('loadUsers failed', e);
        users = [];
      }
      users.forEach(u => { u.status = (u.status || '').toLowerCase(); });
      toggleRoleControls();
      renderCurrentPage();
    }

    // Filtering
    function filterUsers(){
      return users.filter(u => selectedClass === 'all' || (u.class || '').toString() === selectedClass);
    }

    // Render presence cards
    function userCard(u){
      const statusLower = (u.status || '').toLowerCase();
      const avatarField = u.avatar || u.avatarUrl || u.avatar_url || u.avatar_url || '';
      const avatarSrc = normalizeAvatarUrl(avatarField);
      const onerr = `this.onerror=null;this.src='${API_BASE.replace(/\/$/,'')}/avatars/default.jpg'`;
      return `
      <div class="presence-card" data-id="${u.id}">
        <img src="${avatarSrc}" alt="${u.name}" onerror="${onerr}">
        <div class="name">${u.name}</div>
        <div class="text-sm muted">${u.class || ''}</div>
        <div class="status ${statusLower}" style="margin-top:8px">${u.status || 'absent'}</div>
        <div style="margin-top:8px;display:flex;gap:8px;justify-content:center">
          ${canMark() ? `<button class="btn-ghost mark-btn" data-id="${u.id}">Mark</button>` : ''}
          ${isHod() ? `<button class="btn-ghost del-btn" data-id="${u.id}">Delete</button>` : ''}
        </div>
      </div>`;
    }

    function renderPresence(containerId){
      const container = document.getElementById(containerId);
      container.innerHTML = filterUsers().map(userCard).join('');
      wirePresenceButtons();
    }

    function renderDashboard(){
      const data = filterUsers();
      document.getElementById('stat-present').innerText = data.filter(u=> (u.status||'').toLowerCase() === 'present').length;
      document.getElementById('stat-absent').innerText = data.filter(u=> (u.status||'').toLowerCase() === 'absent').length;
      document.getElementById('stat-late').innerText = data.filter(u=> (u.status||'').toLowerCase() === 'late').length;
      document.getElementById('presencePreview').innerHTML = data.slice(0,6).map(userCard).join('');
    }

    async function renderTimeline(){
      const t = document.getElementById('timeline');
      t.innerHTML = '';
      const data = filterUsers().slice(0,12);
      for (const u of data){
        try {
          const hist = await apiFetch(`/api/timeline/${encodeURIComponent(u.id)}`);
          const html = (Array.isArray(hist) ? hist : []).map(h=>`<div style="padding:6px;border-bottom:1px dashed rgba(255,255,255,0.02)"><strong>${h.ts}</strong> ${h.type} - ${h.label || ''}</div>`).join('');
          const entry = document.createElement('div');
          entry.className = 'timeline-entry';
          entry.innerHTML = `<strong>${u.name}</strong> (${u.class}) - ${u.status}<hr>${html}`;
          t.appendChild(entry);
        } catch (e) {
          const entry = document.createElement('div');
          entry.className = 'timeline-entry';
          entry.innerHTML = `<strong>${u.name}</strong> (${u.class}) - ${u.status}<hr>No timeline`;
          t.appendChild(entry);
        }
      }
    }

    async function renderTrustPage(){
      const data = filterUsers();
      const top = [...data].sort((a,b)=> (b.trustScore||0) - (a.trustScore||0)).slice(0,6);
      document.getElementById('trustTopGrid').innerHTML = top.map(u=>{
        const avatarField = u.avatar || u.avatarUrl || u.avatar_url || '';
        const avatarSrc = normalizeAvatarUrl(avatarField);
        const onerr = `this.onerror=null;this.src='${API_BASE.replace(/\/$/,'')}/avatars/default.jpg'`;
        return `
        <div class="top-card">
          <img src="${avatarSrc}" alt="${u.name}" onerror="${onerr}">
          <div class="name">${u.name}</div>
          <div class="class muted">${u.class}</div>
          <div class="score">${u.trustScore}%</div>
        </div>
      `}).join('');
      document.getElementById('trustLeaderboard').innerHTML = [...data].sort((a,b)=> (b.trustScore||0) - (a.trustScore||0)).map((u,i)=>`<div><span>${i+1}. ${u.name} (${u.class})</span><span>${u.trustScore}%</span></div>`).join('');
    }

    function renderInsights(){
      document.getElementById('analyticsList').innerHTML = `
        <div class="searchbox">
          <input id="analyticsSearch" placeholder="Search analytics..." aria-label="Search analytics"/>
          <div class="analytics-badge live-badge" title="Live">LIVE</div>
        </div>
      `;
      for (const a of ANALYTICS){
        const el = document.createElement('div');
        el.className = 'analytics-item';
        el.dataset.id = a.id;
        el.innerHTML = `<div class="meta"><div class="analytics-title">${a.title}</div><div class="analytics-desc">${a.description}</div></div><div class="analytics-badge">View</div>`;
        document.getElementById('analyticsList').appendChild(el);
      }
      document.querySelectorAll('.analytics-item').forEach(item=>{
        item.onclick = () => {
          document.querySelectorAll('.analytics-item').forEach(i=>i.classList.remove('selected'));
          item.classList.add('selected');
          selectedAnalyticsId = item.dataset.id;
          showAnalyticsDetail(selectedAnalyticsId);
        };
      });
      const first = document.querySelector('.analytics-item');
      if(first){
        first.classList.add('selected');
        selectedAnalyticsId = first.dataset.id;
        showAnalyticsDetail(selectedAnalyticsId);
      }
      const search = document.getElementById('analyticsSearch');
      if(search) search.oninput = (e)=> renderInsightsFiltered(e.target.value);
    }

    function renderInsightsFiltered(filterText){
      document.getElementById('analyticsList').innerHTML = `
        <div class="searchbox">
          <input id="analyticsSearch" placeholder="Search analytics..." aria-label="Search analytics" value="${filterText}"/>
          <div class="analytics-badge live-badge" title="Live">LIVE</div>
        </div>
      `;
      for (const a of ANALYTICS){
        if(filterText && !(`${a.title} ${a.description}`.toLowerCase().includes(filterText.toLowerCase()))) continue;
        const el = document.createElement('div');
        el.className = 'analytics-item';
        el.dataset.id = a.id;
        el.innerHTML = `<div class="meta"><div class="analytics-title">${a.title}</div><div class="analytics-desc">${a.description}</div></div><div class="analytics-badge">View</div>`;
        document.getElementById('analyticsList').appendChild(el);
      }
      document.querySelectorAll('.analytics-item').forEach(item=>{
        item.onclick = () => {
          document.querySelectorAll('.analytics-item').forEach(i=>i.classList.remove('selected'));
          item.classList.add('selected');
          selectedAnalyticsId = item.dataset.id;
          showAnalyticsDetail(selectedAnalyticsId);
        };
      });
    }

    function makeLastDays(n){
      const labels = [];
      for (let i=n-1;i>=0;i--){
        if(i===0) labels.push('Today'); else labels.push(`D-${i}`);
      }
      return labels;
    }
    function makeTrend(base, points=7){
      const arr=[];
      for(let i=0;i<points;i++){
        const jitter = Math.round((Math.random()*12)-6);
        let v = Math.max(0, Math.min(100, base + jitter));
        arr.push(v);
      }
      return arr;
    }
    function topByTrust(list, n=5){
      return [...list].sort((a,b)=> (b.trustScore||0) - (a.trustScore||0)).slice(0,n);
    }

    function showAnalyticsDetail(id){
      const analytic = ANALYTICS.find(a=>a.id===id);
      if(!analytic) return;
      const filtered = filterUsers();
      let data;
      if(id === 'late_month'){
        const total = filtered.length || 1;
        const late = filtered.filter(u=> (u.status||'').toLowerCase() === 'late').length;
        const perc = Math.round((late/total)*100);
        data = {
          pie: [late, total-late],
          pieLabels: ['Late','On time'],
          trend: makeTrend(perc,7),
          trendLabels: makeLastDays(7),
          detailsTitle: `${perc}% students late`,
          topStudents: topByTrust(filtered,5)
        };
      } else if(id === 'punctuality_A'){
        const onlyA = filtered.filter(u=> u.class === 'A');
        const total = onlyA.length || 1;
        const notPunctual = onlyA.filter(u=> (u.trustScore||0) < 75 ).length;
        const perc = Math.round((notPunctual/total)*100);
        data = {
          pie: [notPunctual, total-notPunctual],
          pieLabels: ['Not punctual','Punctual'],
          trend: makeTrend(perc,7),
          trendLabels: makeLastDays(7),
          detailsTitle: total===0 ? 'No students in Class A' : `${perc}% not punctual in Class A`,
          topStudents: topByTrust(onlyA,5)
        };
      } else if(id === 'consistent_C'){
        const onlyC = filtered.filter(u=> u.class === 'C');
        const total = onlyC.length || 1;
        const consistent = onlyC.filter(u=> (u.trustScore||0) >= 85).length;
        const perc = Math.round((consistent/total)*100);
        data = {
          pie: [consistent, total-consistent],
          pieLabels: ['Consistent','Not consistent'],
          trend: makeTrend(perc,7),
          trendLabels: makeLastDays(7),
          detailsTitle: total===0 ? 'No students in Class C' : `${perc}% consistent in Class C`,
          topStudents: topByTrust(onlyC,5)
        };
      } else if(id === 'suspicious_count'){
        const total = filtered.length || 1;
        const suspicious = filtered.filter(u=> (u.status||'').toLowerCase() === 'suspicious').length;
        const perc = Math.round((suspicious/total)*100);
        data = {
          pie: [suspicious, total-suspicious],
          pieLabels: ['Suspicious','Normal'],
          trend: makeTrend(perc,7),
          trendLabels: makeLastDays(7),
          detailsTitle: `${suspicious} flagged suspicious`,
          topStudents: topByTrust(filtered,5)
        };
      } else if(id === 'avg_trust'){
        const total = filtered.length || 1;
        const avg = Math.round(filtered.reduce((a,b)=> a + (b.trustScore||0), 0) / total);
        data = {
          pie: [avg, 100-avg],
          pieLabels: ['Avg trust','Remaining to 100'],
          trend: makeTrend(avg,7),
          trendLabels: makeLastDays(7),
          detailsTitle: `Average trust ${avg}%`,
          topStudents: topByTrust(filtered,5)
        };
      } else if(id === 'attendance_rate'){
        const total = filtered.length || 1;
        const present = filtered.filter(u=> (u.status||'').toLowerCase() === 'present').length;
        const perc = Math.round((present/total)*100);
        data = {
          pie: [present, total-present],
          pieLabels: ['Present','Absent'],
          trend: makeTrend(perc,7),
          trendLabels: makeLastDays(7),
          detailsTitle: `${perc}% present`,
          topStudents: topByTrust(filtered,5)
        };
      }

      document.getElementById('insightTitle').innerText = analytic.title;
      document.getElementById('insightDesc').innerText = analytic.description;
      document.getElementById('insightFilterText').innerText = (selectedClass==='all' ? 'All' : selectedClass);
      document.getElementById('insightTime').innerText = new Date().toLocaleString();

      // draw charts
      drawLineChart(document.getElementById('lineChart'), data.trendLabels, data.trend);
      drawPieChart(document.getElementById('pieChart'), data.pie, data.pieLabels);

      document.getElementById('pieLegend').innerHTML = data.pieLabels.map((lab,i)=>{
        const colors = ["#ef4444","#16a34a","#f59e0b","#8b5cf6","#0ea5e9","#e11d48"];
        return `<div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
          <div style="width:12px;height:12px;border-radius:3px;background:${colors[i%colors.length]};"></div>
          <div style="flex:1;color:#eafaff">${lab}</div>
          <div style="font-weight:700;color:#eafaff">${data.pie[i]}</div>
        </div>`;
      }).join("");

      // top students
      const topDiv = document.getElementById('topStudentsList');
      topDiv.innerHTML = data.topStudents && data.topStudents.length ? data.topStudents.map((s,idx)=>`<div><span>${idx+1}. ${s.name}</span><span>${s.trustScore||s.trust}%</span></div>`).join('') : `<div style="color:var(--muted)">No students to show</div>`;

      document.getElementById('quickStats').innerHTML = `<div style="color:var(--muted)">${data.detailsTitle || ''}</div>`;

      const avgTrust = Math.round(filtered.reduce((a,b)=> a + (b.trustScore||0), 0) / (filtered.length || 1));
      document.getElementById('trustNumber').innerText = avgTrust + '%';
      document.getElementById('trustPctDesc').innerText = `Average trust across ${filtered.length} users`;

      const tips = [];
      if(avgTrust < 70) tips.push('Focus on verification — run spot checks for identities.');
      else tips.push('Trust level is good — maintain verification cadence.');
      const suspicious = filtered.filter(u=> (u.status||'').toLowerCase() === 'suspicious').length;
      if(suspicious > 0) tips.push(`Investigate ${suspicious} suspicious flag(s) — review footage or logs.`);
      else tips.push('No suspicious flags — continue monitoring.');
      tips.push('Enable two-factor checks & regular audit to raise trust.');

      document.getElementById('tipsList').innerHTML = tips.map(t=>`<div class="tip">${t}</div>`).join('');
    }

    /* ---------- Canvas chart helpers ---------- */
    function setCanvasForRetina(canvas){
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const width = rect.width || canvas.offsetWidth || 300;
      const height = rect.height || canvas.offsetHeight || 200;
      canvas.width = Math.round(width * dpr);
      canvas.height = Math.round(height * dpr);
      canvas.style.width = width + "px";
      canvas.style.height = height + "px";
      const ctx = canvas.getContext('2d');
      ctx.setTransform(dpr,0,0,dpr,0,0);
      return {ctx, w:width, h:height};
    }
    function clearCanvas(canvas){
      const {ctx, w, h} = setCanvasForRetina(canvas);
      ctx.clearRect(0,0,w,h);
      return {ctx, w, h};
    }

    function drawLineChart(canvas, labels, values){
      const {ctx, w, h} = clearCanvas(canvas);
      if(!values || values.length === 0){
        ctx.fillStyle = "#98a6b8";
        ctx.font = "14px Inter, Arial";
        ctx.fillText("No data", w/2 - 18, h/2);
        return;
      }
      const padding = {left:42, right:18, top:28, bottom:44};
      const chartW = w - padding.left - padding.right;
      const chartH = h - padding.top - padding.bottom;
      // grid
      ctx.strokeStyle = "rgba(255,255,255,0.03)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      for(let i=0;i<5;i++){
        const y = padding.top + (chartH/4)*i;
        ctx.moveTo(padding.left, y);
        ctx.lineTo(w - padding.right, y);
      }
      ctx.stroke();

      const max = Math.max(...values, 10);
      const min = 0;
      const vRange = max - min || 1;

      ctx.lineWidth = 3;
      const grad = ctx.createLinearGradient(0, 0, w, 0);
      grad.addColorStop(0, "rgba(0,255,194,0.95)");
      grad.addColorStop(1, "rgba(79,108,255,0.98)");
      ctx.strokeStyle = grad;
      ctx.beginPath();
      values.forEach((val, idx)=>{
        const x = padding.left + (chartW/(values.length-1 || 1)) * idx;
        const y = padding.top + chartH - ((val - min) / vRange) * chartH;
        if(idx===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();

      ctx.lineTo(padding.left + chartW, padding.top + chartH);
      ctx.lineTo(padding.left, padding.top + chartH);
      ctx.closePath();
      const fillGrad = ctx.createLinearGradient(0, padding.top, 0, padding.top + chartH);
      fillGrad.addColorStop(0, "rgba(79,108,255,0.12)");
      fillGrad.addColorStop(1, "rgba(0,255,194,0.02)");
      ctx.fillStyle = fillGrad;
      ctx.fill();

      // points
      ctx.fillStyle = "#fff";
      ctx.strokeStyle = "#0ea5e9";
      ctx.lineWidth = 1.6;
      ctx.font = "12px Inter, Arial";
      ctx.fillStyle = "#e6f7ff";
      values.forEach((val, idx)=>{
        const x = padding.left + (chartW/(values.length-1 || 1)) * idx;
        const y = padding.top + chartH - ((val - min) / vRange) * chartH;
        ctx.beginPath();
        ctx.arc(x,y,4,0,Math.PI*2);
        ctx.fillStyle = "#071827";
        ctx.fill();
        ctx.strokeStyle = "rgba(79,108,255,0.92)";
        ctx.stroke();
        ctx.fillStyle = "#e6f7ff";
        ctx.fillText(val + "%", x - 14, y - 12);
      });

      ctx.fillStyle = "#e6f7ff";
      ctx.font = "600 13px Inter, Arial";
      ctx.fillText("Trend", 8, 18);
    }

    function drawPieChart(canvas, values, labels){
      const {ctx, w, h} = clearCanvas(canvas);
      const cx = w/2;
      const cy = h/2;
      const radius = Math.min(w, h)/2 - 16;
      const total = values.reduce((a,b)=>a+b,0) || 1;
      const colors = ["#fb7185","#34d399","#f59e0b","#8b5cf6","#0ea5e9","#ff6ec7"];
      let start = -Math.PI/2;
      for(let i=0;i<values.length;i++){
        const slice = values[i] / total;
        const end = start + slice * Math.PI * 2;
        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,radius,start,end);
        ctx.closePath();
        ctx.fillStyle = colors[i % colors.length];
        ctx.fill();
        ctx.strokeStyle = "rgba(0,0,0,0.06)";
        ctx.lineWidth = 1;
        ctx.stroke();
        start = end;
      }
      ctx.fillStyle = "#e6f7ff";
      ctx.font = "700 14px Inter, Arial";
      ctx.textAlign = "center";
      ctx.fillText("Distribution", cx, cy - 6);
      ctx.font = "600 12px Inter, Arial";
      ctx.fillText(`${values[0] || 0}`, cx, cy + 18);
    }

    /* ---------- Navigation & event wiring ---------- */
    function showPage(id){
      document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
      const pageEl = document.getElementById(id);
      if(pageEl) pageEl.classList.add("active");
      document.querySelectorAll(".nav-link").forEach(btn=>{ btn.classList.remove('active'); btn.setAttribute('aria-pressed','false'); });
      const btn = document.querySelector(`.nav-link[data-page="${id}"]`);
      if(btn){ btn.classList.add('active'); btn.setAttribute('aria-pressed','true'); }
      if(id === "page-dashboard") renderDashboard();
      if(id === "page-presence") renderPresence("presenceMap");
      if(id === "page-timeline") renderTimeline();
      if(id === "page-trust") renderTrustPage();
      if(id === "page-insights") { renderInsights(); if(selectedAnalyticsId) showAnalyticsDetail(selectedAnalyticsId); }
      setTimeout(()=>{ if(id==='page-insights' && selectedAnalyticsId) showAnalyticsDetail(selectedAnalyticsId); }, 60);
    }

    document.querySelectorAll(".nav-link").forEach(btn=> btn.addEventListener('click', ()=> showPage(btn.dataset.page)) );

    document.getElementById("openPresence").addEventListener('click', ()=> showPage("page-presence"));

    document.getElementById("classSelector").addEventListener('change', (e)=> {
      selectedClass = e.target.value;
      const active = document.querySelector('.page.active');
      if(active) showPage(active.id);
      else renderDashboard();
    });

    // CSV export
    function exportCSV(rows, filename='snapshot.csv'){
      if(!rows || !rows.length) return;
      const keys = Object.keys(rows[0]);
      const csv = [keys.join(',')].concat(rows.map(r => keys.map(k => `"${String(r[k]).replace(/"/g,'""')}"`).join(','))).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    document.getElementById('downloadSnapshot').addEventListener('click', ()=>{
      const rows = users.map(u=>({ id:u.id, name:u.name, class:u.class, status:u.status, trust:u.trustScore }));
      exportCSV(rows, `presence_snapshot_${Date.now()}.csv`);
    });

    document.getElementById('exportInsightCSV').addEventListener('click', ()=>{
      const filtered = filterUsers();
      const rows = filtered.map(u=>({ id:u.id, name:u.name, class:u.class, status:u.status, trust:u.trustScore }));
      exportCSV(rows, `insight_export_${Date.now()}.csv`);
    });

    document.getElementById('regenUsers').addEventListener('click', ()=>{
      users = (function makeUsers(n=36){
        const NAMES = ["Aarav","Ishaan","Diya","Vivaan","Anaya","Kavya","Rohan","Sneha","Arjun","Riya","Maya","Karthik","Neha","Sahil","Priya","Vikram"];
        const STATUSES = ["present","absent","late","suspicious"];
        return Array.from({length:n}).map((_,i)=>{
          const name = NAMES[i % NAMES.length] + " " + (100+i);
          return {
            id: "U" + (i+1),
            name,
            class: ["A","B","C"][i % 3],
            status: STATUSES[Math.floor(Math.random()*STATUSES.length)],
            trustScore: Math.floor(60 + Math.random()*40),
            avatarUrl: `https://i.pravatar.cc/100?img=${(i%70)+1}`
          };
        });
      })();
      renderCurrentPage();
    });

    document.getElementById('refreshInsight').addEventListener('click', ()=>{
      const t = document.getElementById('insightTime');
      t.innerText = 'Refreshing...';
      setTimeout(()=> showAnalyticsDetail(selectedAnalyticsId), 400);
    });

    document.getElementById('improveScore').addEventListener('click', ()=> alert("Tip: run verification & audits to improve trust score. (Demo)"));

    // WebSocket live updates (single initializer used by app)
    function initWebsocket(){
      try {
        const proto = location.protocol === 'https:' ? 'wss' : 'ws';
        const wsUrl = `${proto}://${location.hostname}:8000/ws/events`;
        const ws = new WebSocket(wsUrl);
        window.pa_ws = ws;
        ws.onopen = ()=> console.log("WS connected", wsUrl);
        ws.onmessage = (ev)=> {
          try{
            const m = JSON.parse(ev.data);
            if(m.type === 'presence' && m.payload){
              loadUsers();
            }
          } catch (e) { console.warn("WS parse", e); }
        };
        ws.onclose = ()=> { window.pa_ws = null; console.log('WS closed'); };
        ws.onerror = (err)=> console.warn("WS error", err);
      } catch(e){ console.warn('init websocket failed', e); }
    }

    // initial load
    (function init(){
      toggleRoleControls();
      loadUsers();
      initWebsocket();
      setInterval(loadUsers, 8000);
      window.addEventListener('resize', ()=> { if(selectedAnalyticsId) showAnalyticsDetail(selectedAnalyticsId); });
    })();

    // ensure charts resize
    window.addEventListener('resize', ()=> { const active = document.querySelector('.page.active'); if(active && active.id === 'page-insights'){ if(selectedAnalyticsId) showAnalyticsDetail(selectedAnalyticsId); } });

    // role helpers
    function isHod(){ return (localStorage.getItem('pa_role') === 'hod'); }
    function isTeacher(){ return (localStorage.getItem('pa_role') === 'teacher'); }
    function isParent(){ return (localStorage.getItem('pa_role') === 'parent'); }
    function canMark(){ return isHod() || isTeacher(); }

    /* ---------- Presence button wiring (delete / mark) ---------- */
    function wirePresenceButtons(){
      document.querySelectorAll('.mark-btn').forEach(btn=>{
        btn.onclick = async (e) => {
          const id = btn.dataset.id;
          btn.disabled = true;
          try {
            await apiFetch('/api/simulate-checkin', {
              method: 'POST',
              headers: {'Content-Type':'application/json'},
              body: JSON.stringify({ student_id: id, status: 'Present' })
            });
            await loadUsers();
          } catch (err){
            console.warn('mark error', err);
            alert('Mark failed');
          } finally {
            btn.disabled = false;
          }
        };
      });

      document.querySelectorAll('.del-btn').forEach(btn=>{
        btn.onclick = async (e) => {
          const id = btn.dataset.id;
          if(!confirm(`Delete student ${id}? This will remove attendance & trust records.`)) return;
          try {
            const res = await apiFetch(`/api/students/${encodeURIComponent(id)}`, { method: 'DELETE' });
            if(res && res.success){
              await loadUsers();
            } else {
              alert('Delete failed: ' + (res && res.detail ? res.detail : JSON.stringify(res)));
            }
          } catch (err){
            console.warn('delete error', err);
            alert('Delete failed');
          }
        };
      });
    }

    /* ---------- Authentication UI / flows ---------- */
    const signModal = document.getElementById('signModal');
    const addModal = document.getElementById('addModal');

    document.getElementById('openSign').addEventListener('click', ()=> {
      document.getElementById('signMsg').innerText = '';
      signModal.style.display = 'block';
    });
    document.getElementById('cancelSign').addEventListener('click', ()=> {
      signModal.style.display = 'none';
    });

    document.getElementById('addStudentBtn').addEventListener('click', ()=> {
      document.getElementById('addMsg').innerText = '';
      document.getElementById('addId').value = '';
      document.getElementById('addName').value = '';
      document.getElementById('addClass').value = '';
      document.getElementById('addMobile').value = '';
      addModal.style.display = 'block';
    });
    document.getElementById('cancelAdd').addEventListener('click', ()=> { addModal.style.display = 'none'; });

    // Sign in action
    document.getElementById('doSign').addEventListener('click', async ()=>{
      const username = document.getElementById('signUser').value.trim();
      const password = document.getElementById('signPass').value.trim();
      const msgEl = document.getElementById('signMsg');
      msgEl.style.color = 'var(--muted)';
      if(!username || !password){ msgEl.innerText = 'Enter username & password'; return; }

      try {
        const j = await apiFetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        if (j && j.token) {
          localStorage.setItem('pa_token', j.token);
          localStorage.setItem('pa_role', j.role || 'teacher');
          localStorage.setItem('pa_user', j.display_name || username);
          if (j.student_id) localStorage.setItem('pa_student_id', j.student_id);
          msgEl.style.color = 'green';
          msgEl.innerText = 'Signed in';
          document.getElementById('signedUser').innerText = j.display_name || username;
          document.getElementById('roleBadge').innerText = (j.role || 'teacher');
          signModal.style.display = 'none';
          toggleRoleControls();
          await loadUsers();
        } else {
          msgEl.style.color = '#ef4444';
          msgEl.innerText = (j && (j.detail || j.message)) ? (j.detail || j.message) : 'Login failed';
        }
      } catch (e) {
        console.warn('login error', e);
        msgEl.style.color = '#ef4444';
        msgEl.innerText = 'Login error';
      }
    });

    // sign out
    document.getElementById('signOut').addEventListener('click', ()=>{
      localStorage.removeItem('pa_token');
      localStorage.removeItem('pa_role');
      localStorage.removeItem('pa_user');
      localStorage.removeItem('pa_student_id');
      document.getElementById('signedUser').innerText = 'Guest';
      document.getElementById('roleBadge').innerText = 'Guest';
      toggleRoleControls();
      loadUsers();
    });

    // toggle controls based on role
    function toggleRoleControls(){
      const addBtn = document.getElementById('addStudentBtn');
      const role = localStorage.getItem('pa_role') || 'guest';
      document.getElementById('signedUser').innerText = localStorage.getItem('pa_user') || 'Guest';
      document.getElementById('roleBadge').innerText = role.charAt(0).toUpperCase() + role.slice(1);
      if(role === 'hod'){
        addBtn.style.display = 'inline-block';
        document.getElementById('openSign').style.display = 'none';
        document.getElementById('signOut').style.display = 'inline-block';
      } else if(role === 'teacher'){
        addBtn.style.display = 'none';
        document.getElementById('openSign').style.display = 'none';
        document.getElementById('signOut').style.display = 'inline-block';
      } else if(role === 'parent'){
        addBtn.style.display = 'none';
        document.getElementById('openSign').style.display = 'none';
        document.getElementById('signOut').style.display = 'inline-block';
      } else {
        addBtn.style.display = 'none';
        document.getElementById('openSign').style.display = 'inline-block';
        document.getElementById('signOut').style.display = 'none';
      }
    }

    // add student submit
    document.getElementById('saveAdd').addEventListener('click', async ()=>{
      const id = document.getElementById('addId').value.trim();
      const name = document.getElementById('addName').value.trim();
      const cls = (document.getElementById('addClass').value || '').trim();
      const mobile = (document.getElementById('addMobile').value || '').trim();
      const avatar = document.getElementById('addAvatar').files[0];
      const face = document.getElementById('addFace').files[0];
      const msgEl = document.getElementById('addMsg');
      msgEl.style.color = 'var(--muted)';
      if(!id || !name){ msgEl.style.color = '#ef4444'; msgEl.innerText = 'ID and Name required'; return; }

      const fd = new FormData();
      fd.append('student_id', id);
      fd.append('name', name);
      fd.append('class_name', cls || 'A');
      fd.append('mobile', mobile || '');
      if(avatar) fd.append('avatar', avatar);
      if(face) fd.append('face', face);

      try {
        const headers = localStorage.getItem('pa_token') ? { 'Authorization': 'Bearer ' + localStorage.getItem('pa_token') } : {};
        const j = await apiFetch('/api/students', {
          method: 'POST',
          headers,
          body: fd
        });

        if(j && j.success){
          msgEl.style.color = 'green';
          msgEl.innerText = 'Student added';
          addModal.style.display = 'none';
          await loadUsers();
        } else {
          msgEl.style.color = '#ef4444';
          msgEl.innerText = (j && j.detail) ? j.detail : JSON.stringify(j);
        }
      } catch (e){
        console.warn('add student error', e);
        msgEl.style.color = '#ef4444';
        msgEl.innerText = 'Server error';
      }
    });

    /* ---------- Loading & rendering orchestration ---------- */
    function renderCurrentPage(){
      document.getElementById('signedUser').innerText = localStorage.getItem('pa_user') || 'Guest';
      document.getElementById('roleBadge').innerText = (localStorage.getItem('pa_role') || 'Guest').toUpperCase();

      const active = document.querySelector('.nav-link.active');
      const pageId = active ? active.dataset.page : 'page-dashboard';
      showPage(pageId);
    }

  </script>
</body>
</html>
